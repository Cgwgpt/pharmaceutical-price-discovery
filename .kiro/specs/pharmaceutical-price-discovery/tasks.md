# 实现计划: 医药价格发现系统

## 概述

按照从简单到复杂的渐进式方式实现系统，每个阶段都能独立运行并提供实用价值。

## 任务

---
### 阶段一：基础框架（MVP）
---

- [x] 1. 项目初始化和基础结构
  - [x] 1.1 创建项目目录结构和配置文件
    - 创建 `app/`, `scraper/`, `tests/` 目录
    - 创建 `requirements.txt` 包含基础依赖
    - 创建 `config.py` 配置文件
    - _需求: 1.5, 2.5_

  - [x] 1.2 实现数据模型层
    - 创建 `app/models.py` 定义 Drug 和 PriceRecord 模型
    - 使用 SQLAlchemy ORM
    - 实现数据库初始化函数
    - _需求: 2.1, 2.4_

  - [x] 1.3 编写数据模型属性测试
    - **Property 2: 数据存储往返一致性**
    - **验证: 需求 1.3, 2.2**

- [x] 2. 基础爬虫实现
  - [x] 2.1 创建Scrapy项目和基础爬虫类
    - 创建 `scraper/items.py` 定义 DrugItem
    - 创建 `scraper/spiders/base_spider.py` 基础爬虫
    - 配置 `scraper/settings.py`
    - _需求: 1.1, 1.2_

  - [x] 2.2 实现数据处理管道
    - 创建 `scraper/pipelines.py`
    - 实现数据清洗逻辑
    - 实现数据库存储逻辑
    - _需求: 1.3, 2.1_

  - [x] 2.3 编写数据提取属性测试
    - **Property 1: 数据提取完整性**
    - **验证: 需求 1.2, 2.1**

- [x] 3. 示例爬虫实现
  - [x] 3.1 实现一个示例药品网站爬虫
    - 创建 `scraper/spiders/example_spider.py`
    - 实现页面解析逻辑
    - 处理分页
    - _需求: 1.1, 1.2_

  - [x] 3.2 实现爬虫错误处理
    - 添加重试机制
    - 实现错误日志记录
    - _需求: 1.4_

  - [ ]* 3.3 编写爬虫容错性属性测试
    - **Property 13: 爬虫容错性**
    - **验证: 需求 1.4, 4.4**

- [x] 4. 检查点 - 确保爬虫功能正常
  - 运行示例爬虫，验证数据采集
  - 确保所有测试通过，如有问题请询问用户

- [x] 5. 基础Web界面
  - [x] 5.1 创建Flask应用框架
    - 创建 `app/__init__.py` 初始化Flask
    - 创建 `app/routes.py` 定义路由
    - 创建 `run.py` 启动入口
    - _需求: 3.1_

  - [x] 5.2 实现价格查询服务
    - 创建 `app/services/price_service.py`
    - 实现 `get_latest_prices()` 方法
    - 实现 `search_drugs()` 方法
    - _需求: 2.3, 3.2_

  - [ ]* 5.3 编写搜索功能属性测试
    - **Property 4: 模糊搜索包含性**
    - **验证: 需求 2.3, 3.2**

  - [x] 5.4 创建HTML模板
    - 创建 `app/templates/base.html` 基础模板
    - 创建 `app/templates/index.html` 首页
    - 创建 `app/templates/search.html` 搜索结果页
    - 创建 `app/templates/404.html` 错误页面
    - _需求: 3.1, 3.2, 3.3_

- [x] 6. 检查点 - 确保MVP功能完整
  - ✅ 验证Web界面可以显示爬取的数据
  - ✅ 验证搜索功能正常工作
  - ✅ 确保所有测试通过 (6/6 tests passed)

---
### 阶段二：多平台比价
---

- [x] 7. 数据标准化模块
  - [x] 7.1 实现药品名称标准化
    - 创建 `app/services/normalize_service.py`
    - 实现名称清洗函数（去空格、特殊字符）
    - 实现规格单位标准化
    - _需求: 6.1, 6.3_

  - [ ]* 7.2 编写数据标准化属性测试
    - **Property 8: 数据标准化一致性**
    - **Property 9: 规格单位标准化**
    - **验证: 需求 6.1, 6.3**

  - [x] 7.3 实现药品标识生成
    - 基于标准化名称生成唯一标识
    - 实现别名映射表
    - _需求: 6.4, 6.2_

  - [ ]* 7.4 编写药品标识属性测试
    - **Property 10: 药品标识唯一性**
    - **验证: 需求 6.4**

- [x] 8. 比价服务实现
  - [x] 8.1 实现比价核心逻辑
    - 创建 `app/services/compare_service.py`
    - 实现 `compare_prices()` 方法
    - 实现价格排序和最低价标识
    - _需求: 5.1, 5.2, 5.3_

  - [ ]* 8.2 编写比价排序属性测试
    - **Property 5: 比价结果排序正确性**
    - **Property 6: 最低价格标识正确性**
    - **验证: 需求 5.2, 5.3, 8.1**

  - [x] 8.3 实现价差计算
    - 计算价差百分比
    - 计算潜在节省金额
    - _需求: 5.5, 8.3_

  - [ ]* 8.4 编写价差计算属性测试
    - **Property 7: 价差百分比计算正确性**
    - **Property 12: 成本节省计算正确性**
    - **验证: 需求 5.5, 8.3**

- [x] 9. 比价界面
  - [x] 9.1 创建比价结果页面
    - 创建 `app/templates/compare.html`
    - 显示各平台价格对比
    - 高亮最低价格
    - _需求: 5.1, 5.2, 5.3_

  - [x] 9.2 添加比价API接口
    - 实现 `/api/compare` 接口
    - 返回JSON格式比价数据
    - _需求: 5.1_

- [x] 10. 检查点 - 确保比价功能完整
  - 验证多平台数据可以正确比较
  - 验证价格排序和计算正确
  - 确保所有测试通过，如有问题请询问用户

---
### 阶段三：智能监控与采购
---

- [x] 11. 价格监控模块
  - [x] 11.1 实现价格历史记录
    - 扩展 `price_service.py` 添加历史查询
    - 实现 `get_price_history()` 方法
    - _需求: 7.1_

  - [ ]* 11.2 编写历史记录属性测试
    - **Property 3: 历史记录累积性**
    - **验证: 需求 2.2**

  - [x] 11.3 实现价格变动检测
    - 创建 `app/services/monitor_service.py`
    - 实现价格变动计算
    - 实现阈值判断逻辑
    - _需求: 7.2, 7.3_

  - [ ]* 11.4 编写价格变动属性测试
    - **Property 11: 价格变动阈值检测**
    - **验证: 需求 7.2, 7.3**

- [x] 12. 采购建议模块
  - [x] 12.1 实现采购建议生成
    - 创建 `app/services/recommendation_service.py`
    - 实现最优渠道推荐
    - 实现节省金额计算
    - _需求: 8.1, 8.3_

  - [x] 12.2 实现价格稳定性分析
    - 计算价格波动率
    - 综合考虑价格和稳定性
    - _需求: 8.2, 8.4_

- [x] 13. 监控和建议界面
  - [x] 13.1 创建药品详情页
    - 创建 `app/templates/drug_detail.html`
    - 显示价格历史趋势
    - 显示采购建议
    - _需求: 7.4, 8.1_

  - [x] 13.2 添加监控配置功能
    - 实现用户自定义监控列表
    - 实现阈值配置
    - _需求: 7.5_

- [x] 14. 最终检查点 - 系统完整性验证
  - 验证所有功能模块正常工作
  - 确保所有测试通过
  - 如有问题请询问用户

---
### 阶段四：批量采集与任务管理
---

- [x] 15. 批量采集模块
  - [x] 15.1 实现药品监控列表
    - 创建 `app/services/crawl_service.py`
    - 实现 `DrugWatchList` 模型（关键词、分类、优先级）
    - 实现监控列表增删改查
    - _需求: 批量采集_

  - [x] 15.2 实现采集任务管理
    - 实现 `CrawlTask` 模型（状态、进度、结果）
    - 实现任务创建、启动、取消
    - 实现异步执行和进度跟踪
    - _需求: 批量采集_

  - [x] 15.3 实现采集API接口
    - `/api/crawl/watch-list` - 监控列表管理
    - `/api/crawl/tasks` - 任务管理
    - `/api/crawl/quick` - 快速采集
    - `/api/crawl/statistics` - 采集统计
    - _需求: 批量采集_

  - [x] 15.4 创建采集管理界面
    - 创建 `app/templates/crawl.html`
    - 监控列表管理（添加、删除、分类筛选）
    - 任务列表（创建、启动、取消、进度）
    - 快速采集功能
    - _需求: 批量采集_

- [x] 16. 检查点 - 批量采集功能验证
  - ✅ 验证监控列表管理正常
  - ✅ 验证任务创建和执行正常
  - ✅ 验证采集统计正常
  - ✅ 所有测试通过 (6/6 tests passed)

## 备注

- 标记 `*` 的任务为可选任务，可跳过以加快MVP开发
- 每个任务都引用了具体的需求编号以便追溯
- 检查点用于确保增量验证，及时发现问题
- 属性测试验证核心业务逻辑的正确性