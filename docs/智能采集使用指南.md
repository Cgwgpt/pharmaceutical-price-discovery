# 智能采集使用指南

## 概述

智能采集是一种**API 优先、Playwright 备选**的采集策略，能够自动选择最优的数据采集方式。

## 为什么需要智能采集？

### 传统方式的问题

1. **纯 API 采集**
   - ✅ 优点：快速（毫秒级）、稳定、高效
   - ❌ 缺点：受 API 限制，可能无法获取所有供应商价格

2. **纯 Playwright 采集**
   - ✅ 优点：可以获取完整数据
   - ❌ 缺点：慢（10-30秒）、资源占用高、不稳定

### 智能采集的优势

智能采集结合了两种方式的优点：

```
┌─────────────────────────────────────────┐
│         智能采集流程                      │
├─────────────────────────────────────────┤
│                                         │
│  1. 优先使用 API 采集                    │
│     ↓                                   │
│  2. 检查数据是否充足                     │
│     ↓                                   │
│  3. 如果不足，使用 Playwright 补充        │
│     ↓                                   │
│  4. 合并去重，返回完整结果                │
│                                         │
└─────────────────────────────────────────┘
```

**性能对比：**

| 采集方式 | 速度 | 数据完整性 | 资源占用 | 推荐度 |
|---------|------|-----------|---------|--------|
| 纯 API | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐ | ⭐⭐⭐ |
| 纯 Playwright | ⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| **智能采集** | **⭐⭐⭐⭐** | **⭐⭐⭐⭐⭐** | **⭐⭐** | **⭐⭐⭐⭐⭐** |

## 使用方法

### 1. Web 界面使用

访问采集管理页面，找到"🧠 智能采集（推荐）"卡片：

```
1. 输入药品名称（必填）
2. 输入药品ID（可选，更精确）
3. 设置最小供应商数（默认5，低于此值将使用 Playwright 补充）
4. 可选：勾选"强制使用 Playwright"跳过 API
5. 点击"🧠 智能采集"按钮
```

### 2. API 调用

```bash
curl -X POST http://localhost:5000/api/crawl/smart \
  -H "Content-Type: application/json" \
  -d '{
    "keyword": "天麻蜜环菌片",
    "min_providers": 5,
    "force_playwright": false
  }'
```

### 3. Python 代码调用

```python
from app.services.crawl_service import CrawlService

service = CrawlService()

# 智能采集
result = service.crawl_with_smart_strategy(
    keyword='天麻蜜环菌片',
    drug_id=None,  # 可选
    force_playwright=False,  # 是否强制使用 Playwright
    min_providers=5,  # 最小供应商数阈值
    save_to_db=True  # 是否保存到数据库
)

# 查看结果
print(f"采集方法: {result['method']}")  # 'api', 'playwright', 或 'hybrid'
print(f"API 采集: {result['api_count']} 个供应商")
print(f"Playwright 补充: {result['playwright_count']} 个供应商")
print(f"总计: {len(result['providers'])} 个供应商")
```

## 参数说明

### `min_providers` (最小供应商数)

- **默认值**: 5
- **说明**: 当 API 采集到的供应商数量少于此值时，自动使用 Playwright 补充
- **建议值**:
  - 常见药品: 5-10
  - 罕见药品: 3-5
  - 追求完整性: 10-20

### `force_playwright` (强制使用 Playwright)

- **默认值**: false
- **说明**: 跳过 API 采集，直接使用 Playwright
- **使用场景**:
  - API 数据质量不佳
  - 需要最完整的数据
  - 调试 Playwright 功能

## 返回结果

```json
{
  "success": true,
  "method": "hybrid",  // 'api', 'playwright', 或 'hybrid'
  "keyword": "天麻蜜环菌片",
  "api_count": 3,
  "playwright_count": 15,
  "saved_count": 18,
  "providers": [
    {
      "provider_name": "XX药业",
      "price": 12.50,
      "drug_name": "天麻蜜环菌片",
      "specification": "0.33g*12片*3板",
      "manufacturer": "XX制药",
      "source": "api"  // 或 "playwright"
    }
    // ... 更多供应商
  ],
  "error": null
}
```

## 实际案例

### 案例1: 常见药品（API 充足）

```
药品: 阿莫西林
结果: 
  - 方法: api
  - API 采集: 15 个供应商
  - Playwright 补充: 0 个
  - 耗时: ~2秒
```

### 案例2: 罕见药品（需要补充）

```
药品: 天麻蜜环菌片
结果:
  - 方法: hybrid
  - API 采集: 3 个供应商
  - Playwright 补充: 15 个
  - 耗时: ~25秒
```

### 案例3: 强制 Playwright

```
药品: 片仔癀
参数: force_playwright=true
结果:
  - 方法: playwright
  - API 采集: 0 个
  - Playwright 补充: 23 个
  - 耗时: ~30秒
```

## 最佳实践

### 1. 批量采集

对于批量采集任务，建议：

```python
# 先用 API 快速采集所有药品
for keyword in keywords:
    result = service.crawl_with_smart_strategy(
        keyword=keyword,
        min_providers=10,  # 设置较高阈值
        save_to_db=True
    )
    
    # 记录需要补充的药品
    if result['method'] == 'api' and result['api_count'] < 10:
        needs_supplement.append(keyword)

# 晚上或空闲时间，用 Playwright 补充
for keyword in needs_supplement:
    result = service.crawl_with_smart_strategy(
        keyword=keyword,
        force_playwright=True,
        save_to_db=True
    )
```

### 2. 定时任务

```python
# 每天凌晨更新价格
# 使用智能采集，自动平衡速度和完整性
scheduler.add_job(
    func=lambda: service.crawl_with_smart_strategy(
        keyword='监控药品',
        min_providers=5
    ),
    trigger='cron',
    hour=2
)
```

### 3. 实时查询

```python
# 用户查询时，优先使用 API
result = service.crawl_with_smart_strategy(
    keyword=user_input,
    min_providers=3,  # 降低阈值，优先速度
    save_to_db=True
)
```

## 故障排查

### 问题1: API 总是返回0个供应商

**原因**: Token 可能失效

**解决**:
```bash
# 检查 Token
cat .token_cache.json

# 重新登录获取 Token
python scraper/utils/auto_login.py
```

### 问题2: Playwright 启动失败

**原因**: 浏览器未安装

**解决**:
```bash
pip install playwright
playwright install chromium
```

### 问题3: 采集速度慢

**原因**: 频繁触发 Playwright

**解决**:
- 降低 `min_providers` 阈值
- 检查 API 采集是否正常工作
- 考虑使用缓存

## 性能优化建议

1. **调整阈值**: 根据实际需求调整 `min_providers`
2. **使用缓存**: 对于频繁查询的药品，使用数据库缓存
3. **异步处理**: 批量采集时使用异步任务队列
4. **限流**: 避免频繁调用 Playwright

## 总结

智能采集是推荐的采集方式，它能够：

✅ 自动选择最优方案  
✅ 平衡速度和完整性  
✅ 降低资源消耗  
✅ 提高采集成功率  

**记住**: Playwright 的价值在于"发现"和"补充"，而非"主力"。
