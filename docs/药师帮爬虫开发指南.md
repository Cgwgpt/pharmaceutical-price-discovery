# 药师帮爬虫开发指南

## 概述

本文档总结了从药师帮(dian.ysbang.cn)获取药品价格数据的完整开发经验，包括API发现、Token管理和数据解析。

## 1. 网站技术分析

### 1.1 网站特点

- **架构**: Vue.js SPA单页应用
- **数据加载**: 所有数据通过API动态获取，HTML页面只有空的挂载点
- **认证方式**: Header中传递Token字段
- **API特点**: 非标准响应码（40001+成功消息=请求成功）

### 1.2 为什么传统爬虫无效

```
主页HTML内容:
<!doctype html>
<html>
<head>...</head>
<body>
  <div id="app"></div>  <!-- 空的Vue挂载点 -->
  <script src="app.xxx.js"></script>
</body>
</html>
```

真实数据在JS执行后通过API加载，必须分析API接口。

## 2. API发现方法

### 2.1 手动分析流程

1. **获取JS文件URL**: 从主页HTML中提取
   ```
   https://staticd.ysbang.cn/static/js/app.e68699e762cb43591b54.js
   ```

2. **正则提取API路径**:
   ```python
   pattern = r'["\']/([\w-]+/[\w-]+/[\w/]+/v\d+)["\']'
   ```

3. **筛选有效接口**: 从696个API中找到搜索相关接口

### 2.2 自动提取工具

```python
from scraper.utils.api_extractor import APIExtractor

extractor = APIExtractor('https://dian.ysbang.cn')
apis = extractor.extract_all()           # 所有API
search_apis = extractor.find_search_apis()  # 搜索相关API
```

### 2.3 关键API接口

| 接口 | 用途 |
|------|------|
| `/wholesale-drug/sales/getRegularSearchPurchaseListForPc/v5430` | 常购常搜列表（主要） |
| `/wholesale-drug/sales/getHomeStreamForPc/v5430` | 首页推荐流 |
| `/wholesale-drug/sales/autoComplete/v5185` | 搜索自动补全 |

## 3. Token管理

### 3.1 Token获取方式

**方式1: 浏览器手动获取（推荐）**
1. 登录 https://dian.ysbang.cn
2. F12打开开发者工具 → Network标签
3. 搜索任意药品，查看请求头中的`Token`字段

**方式2: 使用TokenManager工具**
```python
from scraper.utils.token_manager import TokenManager

manager = TokenManager()
manager.set_token_manually('your_token_here')  # 缓存Token
```

### 3.2 Token过期处理

- Token有效期约24小时
- 过期返回: `{"code": "40020", "message": "该操作需要登录"}`
- TokenManager自动缓存和验证Token

### 3.3 请求头配置

```python
headers = {
    'Token': 'your_token',
    'Content-Type': 'application/json;charset=UTF-8',
    'Origin': 'https://dian.ysbang.cn',
    'Referer': 'https://dian.ysbang.cn/',
}
```

## 4. 数据解析

### 4.1 API响应格式

```json
{
  "code": "40001",
  "message": "药采购首页常购常搜列表成功...",
  "data": [
    {
      "elementType": 0,
      "drug": {
        "drugId": 4363,
        "drugName": "999 感冒灵颗粒 10g*9袋",
        "factory": "华润三九医药股份有限公司",
        "specification": "10g*9袋",
        "unit": "盒",
        "minprice": "13.50",
        "maxprice": "15.92",
        "wholesaleNum": 229
      }
    }
  ]
}
```

### 4.2 数据采集说明

**重要**: 药师帮PC端API返回的是**聚合数据**，每个药品只显示：
- `minprice`: 所有供应商中的最低价
- `maxprice`: 所有供应商中的最高价
- `wholesaleNum`: 供应商数量

**API限制**：
- 搜索API (`getRegularSearchPurchaseListForPc`) 返回按药品聚合的数据
- 无法直接获取每个供应商的具体报价
- 要查看具体供应商价格，需要在药师帮网站上点击药品进入详情页

**数据价值**:
- 价格区间（最低价~最高价）对采购决策有参考价值
- 供应商数量反映市场竞争程度
- 价差百分比可评估议价空间
- 例如：片仔癀 3g*1粒(RX) 有21家供应商，价格¥650~¥733，价差12.8%

**比价逻辑**：
1. 同一产品比价：相同药品名称 + 相同规格 + 相同厂家
2. 可替代产品参考：相同药品名称 + 相同规格，不同厂家

### 4.3 响应码说明

| code | 含义 |
|------|------|
| `0` 或 `"0"` | 标准成功 |
| `"40001"` + message含"成功" | 请求成功（特殊） |
| `"40020"` | Token无效/过期 |
| `"40003"` | 参数错误 |
| `"40050"` | 访问受限 |

### 4.4 字段映射

| API字段 | 含义 |
|---------|------|
| `drugName` | 药品名称 |
| `minprice` | 最低价格 |
| `maxprice` | 最高价格 |
| `specification` | 规格 |
| `factory` | 生产厂家 |
| `unit` | 单位 |
| `drugId` | 药品ID |

## 5. 爬虫使用

### 5.1 基本使用

```bash
# 指定Token和关键词
scrapy crawl ysbang_spider -a token=YOUR_TOKEN -a keyword=阿莫西林

# 使用缓存Token
scrapy crawl ysbang_spider -a keyword=感冒药

# 限制页数
scrapy crawl ysbang_spider -a token=YOUR_TOKEN -a max_pages=5
```

### 5.2 缓存Token后使用

```bash
# 先缓存Token
python -c "
from scraper.utils.token_manager import TokenManager
TokenManager().set_token_manually('your_token')
"

# 后续运行自动使用缓存
scrapy crawl ysbang_spider -a keyword=阿莫西林
```

## 6. 踩坑记录

### 6.1 API路径错误

- `/intel-caigou/search/search/v4380` 是智能采购接口，需要导入Excel
- `/api/xxx` 路径返回404，实际API在 `/wholesale-drug/` 下

### 6.2 响应码误判

- 最初以为40001是错误码，实际是成功
- 需要同时检查code和message

### 6.3 数据嵌套

- 药品数据嵌套在 `data[].drug` 中，不是直接在 `data[]`

## 7. 文件结构

```
scraper/
├── spiders/
│   ├── base_spider.py      # 基础爬虫类
│   ├── example_spider.py   # HTML爬虫模板
│   └── ysbang_spider.py    # 药师帮爬虫
├── utils/
│   ├── api_extractor.py    # API提取工具
│   └── token_manager.py    # Token管理工具
├── items.py                # 数据项定义
├── pipelines.py            # 数据处理管道
├── middlewares.py          # 中间件（错误处理、重试）
└── settings.py             # Scrapy配置
```

## 8. 注意事项

1. **合规使用**: 遵守网站使用条款，设置合理请求间隔
2. **Token安全**: 不要将Token提交到代码仓库
3. **频率控制**: 默认2秒请求间隔，避免被封禁
4. **数据用途**: 仅用于价格比较分析，不用于商业竞争

## 9. API限制说明

### 9.1 单个供应商价格获取限制

药师帮PC端API存在以下限制：

| API | 返回数据 | 限制 |
|-----|---------|------|
| `getRegularSearchPurchaseListForPc` | 聚合数据（min/max价格） | 无法获取单个供应商价格 |
| `getHotWholesalesForProvider` | 供应商热销商品 | 只返回TOP热销商品，不是所有商品 |
| `getHomeStreamForPc` | 推荐流商品 | 不支持关键词搜索 |
| `facetWholesaleList` | 供应商列表 | 只返回供应商信息，不含价格 |

**结论**: 
- 无法通过公开API获取特定药品的所有供应商具体价格
- 只能获取供应商热销商品中的价格
- 如果某药品不在供应商热销列表中，则无法获取该供应商的价格

### 9.2 数据采集策略

1. **聚合数据**: 使用搜索API获取药品的价格范围（min/max）和供应商数量
2. **部分供应商价格**: 遍历供应商热销商品，筛选目标药品
3. **数据价值**: 
   - 聚合数据可用于了解市场价格范围
   - 热销商品价格可作为参考
   - 价差百分比可评估议价空间

### 9.3 示例：片仔癀价格采集

```
药品: 片仔癀 3g*1粒(RX)
聚合数据: ¥650.00 ~ ¥733.29 (21家供应商)
热销商品中找到: 吉药庄 ¥650.00

说明: 21家供应商中，只有吉药庄的热销商品包含片仔癀
其他供应商的片仔癀价格无法通过API获取
```

## 10. Playwright 浏览器自动化爬虫

### 10.1 为什么需要 Playwright

由于药师帮API的限制（见第9节），无法通过API获取特定药品的所有供应商具体价格。Playwright 浏览器自动化可以：

- 模拟真实用户访问网页
- 获取每个供应商的具体报价
- 突破API聚合数据的限制

### 10.2 关键发现

通过分析药师帮网站，发现以下URL模式：

```
# 带 drugId 参数时，显示该药品的所有供应商
https://dian.ysbang.cn/#/indexContent?drugId=138595&searchkey=片仔癀

# 不带 drugId 时，显示所有相关商品（可能包含不同规格）
https://dian.ysbang.cn/#/indexContent?searchkey=片仔癀
```

### 10.3 页面元素选择器

```python
# 商品卡片
cards = await page.query_selector_all('.all-goods-wrapper')

# 药品名称
name_el = await card.query_selector('.goods-name')

# 价格（第二个 font-semibold 是价格数字）
price_spans = await card.query_selector_all('.goods-price-all .font-semibold')
price = await price_spans[1].inner_text()  # 如 "650.00"

# 供应商名称
provider_el = await card.query_selector('.goods-footer-info')

# 厂家
manufacturer_el = await card.query_selector('.goods-manufacturer')
```

### 10.4 使用方法

**命令行测试**:
```bash
# 获取片仔癀 3g*1粒 (drugId=138595) 的所有供应商价格
python scraper/utils/playwright_crawler.py 片仔癀 138595

# 只搜索关键词（返回所有相关商品）
python scraper/utils/playwright_crawler.py 阿莫西林
```

**Python 代码调用**:
```python
from scraper.utils.playwright_crawler import crawl_drug_prices_sync

# 获取特定药品的所有供应商价格
result = crawl_drug_prices_sync(
    keyword='片仔癀',
    drug_id=138595,  # 强烈建议提供
    headless=True
)

print(f"找到 {result['total_found']} 个供应商")
for p in result['providers']:
    print(f"{p['provider_name']}: ¥{p['price']}")
```

**通过 CrawlService 调用**:
```python
from app.services.crawl_service import CrawlService

service = CrawlService()
result = service.crawl_with_playwright(
    keyword='片仔癀',
    drug_id=138595,
    save_to_db=True  # 自动保存到数据库
)
```

### 10.5 实际测试结果

```
搜索: 片仔癀
药品ID: 138595

找到 23 个供应商价格:
  1. 吉药庄: ¥650.00
  2. 惠万家: ¥659.00
  3. 吉药庄: ¥665.00
  4. 众佳康: ¥672.73
  5. 德品惠: ¥680.00
  ...
  23. 玖药惠: ¥9999.00
```

### 10.6 注意事项

1. **Token 配置**: 需要在 `.token_cache.json` 中配置有效的 Token
2. **浏览器安装**: 首次使用需要安装 Playwright 浏览器
   ```bash
   pip install playwright
   playwright install chromium
   ```
3. **系统 Chrome**: 代码会优先使用系统安装的 Chrome，如果不可用则使用 Playwright Chromium
4. **请求频率**: 建议设置合理的请求间隔，避免被封禁
5. **drugId 获取**: 可以通过搜索API获取药品的 drugId

## 11. 扩展建议

- 添加代理池支持
- 实现验证码自动识别
- 添加数据增量更新
- 支持更多药品平台
- 定时任务自动采集价格变化
