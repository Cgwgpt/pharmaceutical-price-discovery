# 医药价格发现系统 - 使用手册

## 目录

1. [系统概述](#系统概述)
2. [快速开始](#快速开始)
3. [功能模块](#功能模块)
   - [首页](#首页)
   - [药品搜索](#药品搜索)
   - [多平台比价](#多平台比价)
   - [价格监控](#价格监控)
   - [批量采集](#批量采集)
4. [API接口](#api接口)
5. [定时任务](#定时任务)
6. [常见问题](#常见问题)

---

## 系统概述

医药价格发现系统是一个自动化的药品价格采集、比价和监控平台，帮助药店和医药企业：

- **自动采集**：从药师帮等平台自动采集药品价格
- **智能比价**：多平台价格对比，自动标识最低价
- **实时监控**：价格变动告警，不错过采购时机
- **采购建议**：基于数据分析的智能采购推荐
- **批量管理**：支持药品监控列表和批量采集任务

### 核心价值

| 场景 | 人工方式 | 自动化方式 | 提升 |
|------|---------|-----------|------|
| 查询1个药品 | 30秒 | 2秒 | 15x |
| 查询100个药品 | 50分钟 | 3分钟 | 17x |
| 每日监控500品种 | 不可行 | 20分钟 | ∞ |

---

## 快速开始

### 1. 环境准备

```bash
# 安装依赖
pip install -r requirements.txt

# 初始化数据库（自动创建）
python -c "from app.models import init_db; from config import DATABASE_URL; init_db(DATABASE_URL)"
```

### 2. 启动系统

```bash
# 启动Web服务
python run.py

# 访问地址
http://localhost:5000
```

### 3. 首次使用

1. 打开浏览器访问 `http://localhost:5000`
2. 点击导航栏「采集」进入采集管理
3. 添加要监控的药品到监控列表
4. 创建采集任务并启动
5. 在「搜索」页面查看采集到的数据

---

## 功能模块

### 首页

**访问路径**：`/` 或点击导航栏「首页」

**功能说明**：
- 显示最近采集的20条药品价格
- 展示系统统计数据（药品总数、价格记录数、数据来源数）
- 快速搜索入口

**界面元素**：
- 统计卡片：药品总数、价格记录、数据来源
- 最新价格列表：药品名称、规格、价格、来源、更新时间

---

### 药品库

**访问路径**：`/drugs` 或点击导航栏「药品库」

**功能说明**：
- 查看所有已采集的药品列表
- 显示每个药品的价格统计信息
- 支持多种排序方式（最近更新、名称、价格数量）
- 分页浏览，每页50条记录

**使用方法**：
1. 点击导航栏「药品库」进入页面
2. 使用排序按钮切换排序方式
3. 点击「查看」按钮查看药品详情
4. 使用分页控件浏览更多药品

**详细使用说明**：参考 [药品库使用指南](./药品库使用指南.md)

---

### 药品搜索

**访问路径**：`/search` 或点击导航栏「搜索」

**功能说明**：
- 支持药品名称模糊搜索
- 支持通用名、商品名、别名搜索
- 分页显示搜索结果

**使用方法**：
1. 在搜索框输入药品名称（如：阿莫西林、布洛芬）
2. 点击「搜索」按钮或按回车
3. 查看搜索结果列表
4. 点击药品名称查看详情

**搜索技巧**：
- 支持部分匹配：输入「阿莫」可搜到「阿莫西林」
- 支持别名搜索：输入「芬必得」可搜到「布洛芬」
- 支持规格筛选：在比价页面可按规格筛选

---

### 多平台比价

**访问路径**：`/compare` 或点击导航栏「比价」

**⚠️ 重要说明**：
- 比价功能用于比较**不同平台**（如药师帮、京东、天猫等）的价格
- 目前系统仅采集了药师帮平台的数据，**暂不支持跨平台比价**
- 如需查看**同一药品的不同供应商价格**，请使用搜索功能 → 点击药品查看详情

**功能说明**：
- 同一药品多平台价格对比
- 自动标识最低价格
- 计算价差百分比和潜在节省金额

**使用方法**：
1. 在搜索框输入药品名称
2. 点击「比价」按钮
3. 查看各平台价格对比表
4. 绿色高亮显示最低价

**比价结果说明**：
- **最低价**：绿色标识，推荐采购渠道
- **价差**：与最低价的差额百分比
- **节省金额**：按采购数量计算的潜在节省

**💡 查看供应商价格的正确方式**：
1. 访问搜索页面：`/search`
2. 搜索药品名称（如：天麻蜜环菌片）
3. 点击药品名称进入详情页
4. 查看所有供应商的价格列表（按价格排序）

**API调用示例**：
```bash
# 比价查询（跨平台）
curl "http://localhost:5000/api/compare?drug=阿莫西林"

# 查看单个药品的供应商价格（推荐）
curl "http://localhost:5000/api/drug/201"

# 搜索药品
curl "http://localhost:5000/api/search?q=天麻蜜环菌片"

# 计算批量采购节省
curl "http://localhost:5000/api/compare/savings?drug=阿莫西林&quantity=100"

# 获取价差排名
curl "http://localhost:5000/api/compare/ranking?limit=20"
```

---

### 价格监控

**访问路径**：`/monitor` 或点击导航栏「监控」

**功能说明**：
- 价格变动实时监控
- 超阈值自动告警
- 价格趋势分析
- 采购建议生成

**界面组成**：

#### 1. 监控汇总
- 今日价格变动数
- 涨价/降价药品数
- 平均变动幅度

#### 2. 价格告警列表
- 显示超过阈值的价格变动
- 默认阈值：5%
- 可调整阈值筛选

#### 3. 采购建议
- 基于价格和稳定性的综合推荐
- 最佳采购时机提示
- 批量采购节省计算

**阈值设置**：
```
URL参数：/monitor?threshold=10
表示只显示变动超过10%的告警
```

**API调用示例**：
```bash
# 获取价格告警
curl "http://localhost:5000/api/monitor/alerts?threshold=5&limit=50"

# 获取每日汇总
curl "http://localhost:5000/api/monitor/summary"

# 获取价格趋势
curl "http://localhost:5000/api/monitor/trend/1?days=30"

# 获取采购建议
curl "http://localhost:5000/api/recommendation/阿莫西林?quantity=100"
```

---

### 批量采集

**访问路径**：`/crawl` 或点击导航栏「采集」

**功能说明**：
- 药品监控列表管理
- 批量采集任务创建和执行
- 采集进度实时跟踪
- 快速采集功能

#### 1. 药品监控列表

**添加药品**：
1. 点击「+ 添加药品」按钮
2. 输入药品名称（每行一个，支持批量）
3. 选择分类（如：感冒药、抗生素、心血管）
4. 设置优先级（普通/重要/紧急）
5. 点击「添加」

**管理监控列表**：
- 按分类筛选：使用下拉框选择分类
- 移除药品：点击药品右侧的「✕」按钮
- 查看采集记录：显示采集次数和最后采集时间

#### 2. 采集任务

**创建任务**：
1. 点击「从监控列表创建任务」
2. 可选择按分类筛选
3. 系统自动创建包含所有监控药品的任务

**启动任务**：
1. 在任务列表找到「等待中」状态的任务
2. 点击「启动」按钮
3. 任务开始异步执行

**查看进度**：
- 进度条显示完成百分比
- 实时更新采集数量
- 日志区域显示详细信息

**取消任务**：
- 点击运行中任务的「取消」按钮
- 任务将在当前关键词完成后停止

#### 3. 快速采集

适用于临时采集少量药品：
1. 在「快速采集」区域输入药品名称
2. 每行一个药品名称
3. 点击「🚀 立即采集」
4. 等待采集完成，查看结果

#### 4. 智能采集（推荐）⭐

**功能说明**：
智能采集是**推荐的采集方式**，它采用"API 优先、Playwright 备选"的策略，自动选择最优的数据采集方式。

**工作原理**：
```
1. 优先使用快速的 API 采集
   ↓
2. 检查数据是否充足（供应商数量）
   ↓
3. 如果不足，自动使用 Playwright 补充
   ↓
4. 合并去重，返回完整结果
```

**优势对比**：

| 采集方式 | 速度 | 数据完整性 | 资源占用 | 推荐度 |
|---------|------|-----------|---------|--------|
| 纯 API | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐ | ⭐⭐⭐ |
| 纯 Playwright | ⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| **智能采集** | **⭐⭐⭐⭐** | **⭐⭐⭐⭐⭐** | **⭐⭐** | **⭐⭐⭐⭐⭐** |

**使用方法**：
1. 在「单个药品采集」区域输入药品名称
2. 选择「智能模式」（默认推荐）
3. 可选填药品ID（更精确，但通常不需要）
4. 设置最小供应商数（默认5，低于此值将使用 Playwright 补充）
5. 点击「🎯 开始采集」按钮
6. 等待采集完成

**关于药品ID（drugId）**：

💡 **大多数情况下不需要提供药品ID！** 只需输入药品名称，系统会自动搜索并采集。

**什么时候需要药品ID？**
- 当搜索结果有多个同名药品时，需要指定具体哪一个
- 当您已经知道准确的drugId，想要更快速精确的采集

**如何获取药品ID？**
1. 打开药师帮网站：https://dian.ysbang.cn
2. 搜索药品名称，如"天麻蜜环菌片"
3. 点击进入药品详情页
4. 查看浏览器地址栏：`https://dian.ysbang.cn/goods/detail?drugId=4363`
5. 红色数字部分（4363）就是 drugId

**示例**：
```
药品：天麻蜜环菌片
URL：https://dian.ysbang.cn/goods/detail?drugId=4363
drugId：4363
```

⚠️ **注意**：不同规格、不同厂家的同名药品，drugId 不同。如果不确定，建议留空。

**返回结果**：
- 采集方法：api / playwright / hybrid（混合）
- API 采集的供应商数
- Playwright 补充的供应商数
- 所有供应商价格列表（标注来源）
- 自动保存到数据库

**参数说明**：
- **最小供应商数**：当 API 采集到的供应商数量少于此值时，自动使用 Playwright 补充
  - 常见药品：5-10
  - 罕见药品：3-5
  - 追求完整性：10-20

**实际案例**：

案例1 - 常见药品（API 充足）：
```
药品: 阿莫西林
结果: 
  - 方法: api
  - API 采集: 15 个供应商
  - Playwright 补充: 0 个
  - 耗时: ~2秒
```

案例2 - 罕见药品（需要补充）：
```
药品: 天麻蜜环菌片
结果:
  - 方法: hybrid
  - API 采集: 3 个供应商
  - Playwright 补充: 15 个
  - 耗时: ~25秒
```

**API调用示例**：
```bash
# 智能采集（推荐）- 不提供drugId
curl -X POST "http://localhost:5000/api/crawl/smart" \
  -H "Content-Type: application/json" \
  -d '{
    "keyword": "天麻蜜环菌片",
    "min_providers": 5
  }'

# 智能采集 - 提供drugId（更精确）
curl -X POST "http://localhost:5000/api/crawl/smart" \
  -H "Content-Type: application/json" \
  -d '{
    "keyword": "天麻蜜环菌片",
    "drug_id": 4363,
    "min_providers": 5
  }'
```

**Python 代码示例**：
```python
from app.services.crawl_service import CrawlService

service = CrawlService()

# 智能采集（不提供drugId）
result = service.crawl_with_smart_strategy(
    keyword='天麻蜜环菌片',
    min_providers=5,
    save_to_db=True
)

# 智能采集（提供drugId）
result = service.crawl_with_smart_strategy(
    keyword='天麻蜜环菌片',
    drug_id=4363,
    min_providers=5,
    save_to_db=True
)

print(f"采集方法: {result['method']}")
print(f"API: {result['api_count']} 个供应商")
print(f"Playwright: {result['playwright_count']} 个供应商")
print(f"总计: {len(result['providers'])} 个供应商")
```

**性能对比演示**：
```bash
# 运行性能对比脚本
python demo_smart_vs_traditional.py
```

#### 5. Playwright 采集（仅在必要时使用）

**功能说明**：
普通采集只能获取聚合的最低/最高价格，而 Playwright 采集可以获取每个供应商的具体价格。

⚠️ **注意**：Playwright 采集速度较慢（10-30秒），建议优先使用上方的"智能采集"。

**工作原理**：
1. 使用 Playwright 启动浏览器
2. 拦截页面发出的 API 请求
3. 从 API 响应中提取供应商价格信息

**使用方法**：
1. 在「Playwright 采集」区域输入药品名称
2. 可选填药品ID（更精确）
3. 设置最大供应商数量
4. 点击「🎭 Playwright 采集供应商价格」
5. 等待采集完成（约10-30秒）

**返回结果**：
- 药品名称
- 所有供应商的具体价格（按价格排序）
- 价格统计（最低、最高、平均）
- 自动保存到数据库

**注意事项**：
- 需要先安装 Playwright：`pip install playwright && playwright install chromium`
- 需要有效的 Token
- 采集时间较长（需要启动浏览器）

**API调用示例**：
```bash
# Playwright 采集单个药品的所有供应商价格
curl -X POST "http://localhost:5000/api/crawl/playwright/detail" \
  -H "Content-Type: application/json" \
  -d '{"keyword": "片仔癀", "max_providers": 50}'

# 带药品ID的精确采集
curl -X POST "http://localhost:5000/api/crawl/playwright/detail" \
  -H "Content-Type: application/json" \
  -d '{"keyword": "片仔癀", "drug_id": 4363, "max_providers": 100}'

# Playwright 搜索并采集多个药品
curl -X POST "http://localhost:5000/api/crawl/playwright/search" \
  -H "Content-Type: application/json" \
  -d '{"keyword": "感冒", "max_items": 10}'
```

**命令行测试**：
```bash
# 测试 Playwright 采集
python scraper/utils/playwright_crawler.py 片仔癀

# 带药品ID
python scraper/utils/playwright_crawler.py 片仔癀 4363
```

#### 6. 采集方式选择建议

**推荐使用顺序**：

1. **智能采集**（首选）⭐⭐⭐⭐⭐
   - 适用场景：所有场景
   - 优点：自动选择最优方案，平衡速度和完整性
   - 缺点：无

2. **快速采集**（临时使用）⭐⭐⭐
   - 适用场景：临时查询少量药品
   - 优点：简单快速
   - 缺点：只能获取聚合价格

3. **Playwright 采集**（特殊需求）⭐⭐
   - 适用场景：需要最完整数据，且不在意速度
   - 优点：数据最完整
   - 缺点：速度慢，资源占用高

**最佳实践**：
- 日常使用：智能采集
- 批量任务：智能采集（设置合理的 min_providers）
- 实时查询：智能采集（降低 min_providers 优先速度）
- 数据补充：Playwright 采集（force_playwright=true）



**API调用示例**：
```bash
# 获取监控列表
curl "http://localhost:5000/api/crawl/watch-list"

# 添加到监控列表
curl -X POST "http://localhost:5000/api/crawl/watch-list" \
  -H "Content-Type: application/json" \
  -d '{"keywords": ["阿莫西林", "布洛芬"], "category": "常用药"}'

# 创建采集任务
curl -X POST "http://localhost:5000/api/crawl/tasks" \
  -H "Content-Type: application/json" \
  -d '{"use_watch_list": true}'

# 启动任务
curl -X POST "http://localhost:5000/api/crawl/tasks/1/start"

# 查看任务进度
curl "http://localhost:5000/api/crawl/tasks/1"

# 快速采集
curl -X POST "http://localhost:5000/api/crawl/quick" \
  -H "Content-Type: application/json" \
  -d '{"keywords": ["阿莫西林", "布洛芬"]}'

# 获取采集统计
curl "http://localhost:5000/api/crawl/statistics"
```

---

## API接口

### 接口列表

| 模块 | 接口 | 方法 | 说明 |
|------|------|------|------|
| 价格 | `/api/prices` | GET | 获取最新价格列表 |
| 搜索 | `/api/search` | GET | 搜索药品 |
| 详情 | `/api/drug/<id>` | GET | 获取药品详情 |
| 比价 | `/api/compare` | GET | 多平台比价 |
| 比价 | `/api/compare/savings` | GET | 计算节省金额 |
| 比价 | `/api/compare/ranking` | GET | 价差排名 |
| 监控 | `/api/monitor/alerts` | GET | 价格告警 |
| 监控 | `/api/monitor/summary` | GET | 每日汇总 |
| 监控 | `/api/monitor/trend/<id>` | GET | 价格趋势 |
| 建议 | `/api/recommendation/<name>` | GET | 采购建议 |
| 建议 | `/api/recommendation/opportunities` | GET | 采购机会 |
| 告警 | `/api/alerts` | GET | 告警列表 |
| 告警 | `/api/alerts/<id>/read` | POST | 标记已读 |
| 采集 | `/api/crawl/watch-list` | GET/POST | 监控列表 |
| 采集 | `/api/crawl/tasks` | GET/POST | 任务管理 |
| 采集 | `/api/crawl/tasks/<id>/start` | POST | 启动任务 |
| 采集 | `/api/crawl/quick` | POST | 快速采集 |
| 采集 | `/api/crawl/playwright` | POST | Playwright采集 |
| 采集 | `/api/crawl/playwright/detail` | POST | Playwright获取供应商价格（推荐） |
| 采集 | `/api/crawl/playwright/search` | POST | Playwright搜索采集 |
| 报告 | `/api/reports` | GET | 报告列表 |
| 报告 | `/api/reports/daily` | POST | 生成日报 |

### 响应格式

所有API返回JSON格式：
```json
{
  "code": 0,        // 0=成功，其他=错误码
  "data": {...},    // 返回数据
  "message": "..."  // 提示信息（可选）
}
```

---

## 定时任务

系统内置定时任务调度器，支持自动化运行。

### 默认任务

| 任务 | 执行时间 | 说明 |
|------|---------|------|
| 每日采集 | 每天 08:00 | 自动采集监控列表药品 |
| 价格告警 | 每小时 | 检测价格变动并生成告警 |
| 日报生成 | 每天 22:00 | 生成每日价格报告 |

### 启动调度器

```python
from app.scheduler import get_scheduler

scheduler = get_scheduler()
scheduler.start()
```

### 手动触发

```bash
# 手动触发采集
curl -X POST "http://localhost:5000/api/scheduler/crawl" \
  -H "Content-Type: application/json" \
  -d '{"keywords": ["阿莫西林"]}'

# 添加定时任务
curl -X POST "http://localhost:5000/api/scheduler/add-job" \
  -H "Content-Type: application/json" \
  -d '{"keyword": "布洛芬", "interval_hours": 12}'
```

---

## 常见问题

### Q1: 采集不到数据？

**可能原因**：
1. 网络连接问题
2. 目标网站API变更
3. Token过期

**解决方法**：
1. 检查网络连接
2. 查看日志 `logs/` 目录
3. 更新Token配置

### Q2: 如何添加新的数据源？

1. 在 `scraper/spiders/` 创建新爬虫
2. 继承 `BaseSpider` 类
3. 实现 `parse` 方法
4. 配置 `scraper/settings.py`

### Q3: 数据库在哪里？

默认使用SQLite，文件位置：`pharma_prices.db`

可在 `config.py` 修改数据库配置：
```python
DATABASE_URL = 'sqlite:///pharma_prices.db'
# 或使用MySQL
# DATABASE_URL = 'mysql://user:pass@localhost/pharma'
```

### Q4: 如何备份数据？

```bash
# SQLite备份
cp pharma_prices.db pharma_prices_backup.db

# 导出报告
curl -X POST "http://localhost:5000/api/reports/daily"
```

### Q5: 采集任务卡住了？

1. 检查任务状态：`/api/crawl/tasks/<id>`
2. 取消任务：`POST /api/crawl/tasks/<id>/cancel`
3. 重新创建任务

---

## 技术支持

- 项目文档：`docs/` 目录
- 开发指南：`docs/药师帮爬虫开发指南.md`
- 问题反馈：提交Issue

---

*医药价格发现系统 © 2025*
