{% extends "base.html" %}

{% block title %}ä»·æ ¼ç›‘æ§ä¸­å¿ƒ - åŒ»è¯ä»·æ ¼å‘ç°ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h4>ğŸ“¡ ä»·æ ¼ç›‘æ§ä¸­å¿ƒ</h4>
        <p class="text-muted">å®æ—¶ç›‘æ§è¯å“ä»·æ ¼å˜åŠ¨ï¼Œå‘ç°æœ€ä½³é‡‡è´­æ—¶æœº</p>
    </div>
</div>

<!-- é‡‡è´­æœºä¼šæé†’ -->
{% if summary.price_down_count > 0 %}
<div class="alert alert-success mb-4">
    <h5 class="alert-heading">ğŸ’° é‡‡è´­æœºä¼šæé†’</h5>
    <p class="mb-0">
        å‘ç° <strong>{{ summary.price_down_count }}</strong> ä¸ªè¯å“ä»·æ ¼ä¸‹é™ï¼Œ
        å»ºè®®å…³æ³¨å¹¶è€ƒè™‘é‡‡è´­ï¼
    </p>
</div>
{% endif %}

<!-- ç›‘æ§æ¦‚è§ˆ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ summary.crawled_count }}</h3>
                <p class="mb-0">ä»Šæ—¥æ›´æ–°</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ summary.price_down_count }}</h3>
                <p class="mb-0">ğŸ”» é™ä»·è¯å“</p>
                <small>é‡‡è´­è‰¯æœº</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h3>{{ summary.price_up_count }}</h3>
                <p class="mb-0">ğŸ”º æ¶¨ä»·è¯å“</p>
                <small>å…³æ³¨åº“å­˜</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>{{ summary.alert_count }}</h3>
                <p class="mb-0">ä»·æ ¼æ³¢åŠ¨</p>
                <small>è¶…è¿‡é˜ˆå€¼</small>
            </div>
        </div>
    </div>
</div>

<!-- é™ä»·è¯å“ - é‡‡è´­æœºä¼š -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">ğŸ’° é™ä»·è¯å“ - é‡‡è´­æœºä¼š</h5>
            </div>
            <div class="card-body">
                {% set down_alerts = alerts | selectattr('direction', 'equalto', 'down') | list %}
                {% if down_alerts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>è¯å“åç§°</th>
                                <th>è§„æ ¼</th>
                                <th>åŸä»·</th>
                                <th>ç°ä»·</th>
                                <th>é™å¹…</th>
                                <th>èŠ‚çœé‡‘é¢</th>
                                <th>é‡‡è´­å»ºè®®</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in down_alerts[:20] %}
                            {% set savings = alert.previous_price - alert.current_price %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('main.drug_detail', drug_id=alert.drug_id) }}">
                                        {{ alert.drug_name[:25] }}{% if alert.drug_name|length > 25 %}...{% endif %}
                                    </a>
                                </td>
                                <td>{{ alert.specification or '-' }}</td>
                                <td class="text-muted"><del>Â¥{{ "%.2f"|format(alert.previous_price) }}</del></td>
                                <td class="text-success fw-bold">Â¥{{ "%.2f"|format(alert.current_price) }}</td>
                                <td>
                                    <span class="badge bg-success">â†“ {{ "%.1f"|format(alert.change_percent|abs) }}%</span>
                                </td>
                                <td class="text-success">Â¥{{ "%.2f"|format(savings) }}/ä»¶</td>
                                <td>
                                    {% if alert.change_percent|abs >= 10 %}
                                    <span class="badge bg-danger">å¼ºçƒˆå»ºè®®é‡‡è´­</span>
                                    {% elif alert.change_percent|abs >= 5 %}
                                    <span class="badge bg-warning text-dark">å»ºè®®é‡‡è´­</span>
                                    {% else %}
                                    <span class="badge bg-secondary">å¯è€ƒè™‘</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('main.compare') }}?drug={{ alert.drug_name }}" 
                                       class="btn btn-sm btn-outline-primary">æ¯”ä»·</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">æš‚æ— é™ä»·è¯å“</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- æ¶¨ä»·é¢„è­¦ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">âš ï¸ æ¶¨ä»·é¢„è­¦ - å…³æ³¨åº“å­˜</h5>
            </div>
            <div class="card-body">
                {% set up_alerts = alerts | selectattr('direction', 'equalto', 'up') | list %}
                {% if up_alerts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>è¯å“åç§°</th>
                                <th>è§„æ ¼</th>
                                <th>åŸä»·</th>
                                <th>ç°ä»·</th>
                                <th>æ¶¨å¹…</th>
                                <th>å¢åŠ æˆæœ¬</th>
                                <th>å»ºè®®</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in up_alerts[:20] %}
                            {% set extra_cost = alert.current_price - alert.previous_price %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('main.drug_detail', drug_id=alert.drug_id) }}">
                                        {{ alert.drug_name[:25] }}{% if alert.drug_name|length > 25 %}...{% endif %}
                                    </a>
                                </td>
                                <td>{{ alert.specification or '-' }}</td>
                                <td class="text-muted">Â¥{{ "%.2f"|format(alert.previous_price) }}</td>
                                <td class="text-danger fw-bold">Â¥{{ "%.2f"|format(alert.current_price) }}</td>
                                <td>
                                    <span class="badge bg-danger">â†‘ {{ "%.1f"|format(alert.change_percent|abs) }}%</span>
                                </td>
                                <td class="text-danger">+Â¥{{ "%.2f"|format(extra_cost) }}/ä»¶</td>
                                <td>
                                    {% if alert.change_percent|abs >= 10 %}
                                    <span class="badge bg-danger">æ£€æŸ¥åº“å­˜</span>
                                    {% elif alert.change_percent|abs >= 5 %}
                                    <span class="badge bg-warning text-dark">å…³æ³¨èµ°åŠ¿</span>
                                    {% else %}
                                    <span class="badge bg-secondary">æ­£å¸¸æ³¢åŠ¨</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('main.compare') }}?drug={{ alert.drug_name }}" 
                                       class="btn btn-sm btn-outline-primary">æ¯”ä»·</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">æš‚æ— æ¶¨ä»·é¢„è­¦</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- é‡‡è´­å»ºè®®æ±‡æ€» -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ğŸ“‹ é‡‡è´­å»ºè®®æ±‡æ€»</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% set down_alerts = alerts | selectattr('direction', 'equalto', 'down') | list %}
                    {% set strong_buy = down_alerts | selectattr('change_percent', 'lt', -10) | list %}
                    {% set suggest_buy = down_alerts | selectattr('change_percent', 'lt', -5) | selectattr('change_percent', 'ge', -10) | list %}
                    
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>ğŸ”¥ å¼ºçƒˆå»ºè®®é‡‡è´­ï¼ˆé™å¹…â‰¥10%ï¼‰</span>
                        <span class="badge bg-danger rounded-pill">{{ strong_buy|length }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>ğŸ‘ å»ºè®®é‡‡è´­ï¼ˆé™å¹…5-10%ï¼‰</span>
                        <span class="badge bg-warning text-dark rounded-pill">{{ suggest_buy|length }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>ğŸ“¦ å¯è€ƒè™‘é‡‡è´­ï¼ˆé™å¹…<5%ï¼‰</span>
                        <span class="badge bg-secondary rounded-pill">{{ (down_alerts|length) - (strong_buy|length) - (suggest_buy|length) }}</span>
                    </li>
                </ul>
                
                {% if strong_buy %}
                <div class="mt-3">
                    <h6>ğŸ”¥ å¼ºçƒˆå»ºè®®é‡‡è´­ï¼š</h6>
                    <ul class="small">
                        {% for alert in strong_buy[:5] %}
                        <li>{{ alert.drug_name }} - é™ä»· {{ "%.1f"|format(alert.change_percent|abs) }}%</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ğŸ“ˆ ä»·æ ¼æ³¢åŠ¨æœ€å¤§çš„è¯å“</h5>
            </div>
            <div class="card-body">
                {% if alerts %}
                <ul class="list-group list-group-flush">
                    {% for alert in alerts[:8] %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{{ url_for('main.compare') }}?drug={{ alert.drug_name }}" class="text-decoration-none">
                                {{ alert.drug_name[:20] }}{% if alert.drug_name|length > 20 %}...{% endif %}
                            </a>
                            <br>
                            <small class="text-muted">{{ alert.specification or '-' }}</small>
                        </div>
                        <div class="text-end">
                            {% if alert.direction == 'down' %}
                            <span class="badge bg-success">â†“ {{ "%.1f"|format(alert.change_percent|abs) }}%</span>
                            <br><small class="text-success">Â¥{{ "%.2f"|format(alert.current_price) }}</small>
                            {% else %}
                            <span class="badge bg-danger">â†‘ {{ "%.1f"|format(alert.change_percent|abs) }}%</span>
                            <br><small class="text-danger">Â¥{{ "%.2f"|format(alert.current_price) }}</small>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center">æš‚æ— ä»·æ ¼æ³¢åŠ¨æ•°æ®</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ç›‘æ§è®¾ç½® -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">âš™ï¸ ç›‘æ§è®¾ç½®</h5>
            </div>
            <div class="card-body">
                <form id="monitorForm" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">ä»·æ ¼å˜åŠ¨é˜ˆå€¼ (%)</label>
                        <input type="number" class="form-control" id="threshold" 
                               value="{{ threshold or 5 }}" min="1" max="50">
                        <small class="text-muted">ä»·æ ¼å˜åŠ¨è¶…è¿‡æ­¤ç™¾åˆ†æ¯”æ—¶æ˜¾ç¤º</small>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">é‡ç‚¹ç›‘æ§è¯å“</label>
                        <textarea class="form-control" id="watchList" rows="2" 
                                  placeholder="è¾“å…¥è¯å“åç§°ï¼Œæ¯è¡Œä¸€ä¸ª">{{ watch_list | join('\n') if watch_list else '' }}</textarea>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="location.reload()">åˆ·æ–°æ•°æ®</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('monitorForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const threshold = document.getElementById('threshold').value;
    const watchList = document.getElementById('watchList').value;
    
    localStorage.setItem('monitor_threshold', threshold);
    localStorage.setItem('monitor_watch_list', watchList);
    
    // è·³è½¬åˆ°æ–°é˜ˆå€¼
    window.location.href = '{{ url_for("main.monitor") }}?threshold=' + threshold;
});

window.onload = function() {
    const savedThreshold = localStorage.getItem('monitor_threshold');
    const savedWatchList = localStorage.getItem('monitor_watch_list');
    
    if (savedThreshold) {
        document.getElementById('threshold').value = savedThreshold;
    }
    if (savedWatchList) {
        document.getElementById('watchList').value = savedWatchList;
    }
};
</script>
{% endblock %}
