{% extends "base.html" %}

{% block title %}å·²é‡‡é›†è¯å“åˆ—è¡¨ - åŒ»è¯ä»·æ ¼å‘ç°ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>ğŸ“š è¯å“åº“</h2>
        <p class="text-muted">æµè§ˆå’Œæœç´¢æ‰€æœ‰å·²é‡‡é›†çš„è¯å“</p>
    </div>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ total }}</h3>
                <small>è¯å“æ€»æ•°</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ drugs|selectattr('price_count')|sum(attribute='price_count') }}</h3>
                <small>ä»·æ ¼è®°å½•æ€»æ•°</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>{{ page }}</h3>
                <small>å½“å‰é¡µ</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h3>{{ pages }}</h3>
                <small>æ€»é¡µæ•°</small>
            </div>
        </div>
    </div>
</div>

<!-- æœç´¢å’Œè§†å›¾åˆ‡æ¢ -->
<div class="row mb-3">
    <div class="col-md-8 mb-2 mb-md-0">
        <form action="{{ url_for('main.drugs_list') }}" method="get" class="d-flex">
            <input type="text" 
                   name="q" 
                   class="form-control me-2" 
                   placeholder="æœç´¢è¯å“åç§°ã€å‚å®¶æˆ–è§„æ ¼..." 
                   value="{{ keyword or '' }}"
                   autofocus>
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <input type="hidden" name="view" value="{{ view_mode }}">
            <button type="submit" class="btn btn-primary">
                ğŸ” æœç´¢
            </button>
            {% if keyword %}
            <a href="{{ url_for('main.drugs_list', sort=sort_by, view=view_mode) }}" class="btn btn-outline-secondary ms-2">
                âœ• æ¸…é™¤
            </a>
            {% endif %}
        </form>
    </div>
    <div class="col-md-4">
        <div class="btn-group float-md-end w-100" role="group">
            <a href="{{ url_for('main.drugs_list', sort=sort_by, q=keyword, view='table') }}" 
               class="btn btn-sm {{ 'btn-primary' if view_mode == 'table' else 'btn-outline-primary' }}"
               title="è¡¨æ ¼è§†å›¾">
                ğŸ“Š è¡¨æ ¼
            </a>
            <a href="{{ url_for('main.drugs_list', sort=sort_by, q=keyword, view='card') }}" 
               class="btn btn-sm {{ 'btn-primary' if view_mode == 'card' else 'btn-outline-primary' }}"
               title="å¡ç‰‡è§†å›¾">
                ğŸ´ å¡ç‰‡
            </a>
        </div>
    </div>
</div>

<!-- æ’åºé€‰é¡¹ -->
<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group" role="group">
            <a href="{{ url_for('main.drugs_list', sort='updated', page=1, q=keyword, view=view_mode) }}" 
               class="btn btn-sm {{ 'btn-primary' if sort_by == 'updated' else 'btn-outline-primary' }}">
                ğŸ•’ æœ€è¿‘æ›´æ–°
            </a>
            <a href="{{ url_for('main.drugs_list', sort='name', page=1, q=keyword, view=view_mode) }}" 
               class="btn btn-sm {{ 'btn-primary' if sort_by == 'name' else 'btn-outline-primary' }}">
                ğŸ”¤ æŒ‰åç§°
            </a>
            <a href="{{ url_for('main.drugs_list', sort='price_count', page=1, q=keyword, view=view_mode) }}" 
               class="btn btn-sm {{ 'btn-primary' if sort_by == 'price_count' else 'btn-outline-primary' }}">
                ğŸ“Š æŒ‰ä»·æ ¼æ•°é‡
            </a>
        </div>
    </div>
</div>

{% if keyword %}
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info mb-0">
            <strong>ğŸ” æœç´¢ç»“æœï¼š</strong>æ‰¾åˆ° {{ total }} ä¸ªåŒ…å« "{{ keyword }}" çš„è¯å“
        </div>
    </div>
</div>
{% endif %}

<!-- è¯å“åˆ—è¡¨ -->
<div class="row">
    <div class="col-12">
        {% if view_mode == 'card' %}
        <!-- å¡ç‰‡è§†å›¾ -->
        <div class="row">
            {% if drugs %}
                {% for drug in drugs %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card card-hover h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="{{ url_for('main.drug_detail', drug_id=drug.id) }}" class="text-decoration-none">
                                    {{ drug.name }}
                                </a>
                            </h5>
                            <p class="card-text text-muted">
                                {% if drug.specification %}
                                <small>ğŸ“¦ è§„æ ¼ï¼š{{ drug.specification }}</small><br>
                                {% endif %}
                                {% if drug.manufacturer %}
                                <small>ğŸ­ å‚å®¶ï¼š{{ drug.manufacturer[:30] }}{% if drug.manufacturer|length > 30 %}...{% endif %}</small><br>
                                {% endif %}
                                <small>ğŸ“Š ä»·æ ¼æ•°é‡ï¼š<span class="badge bg-primary">{{ drug.price_count }}</span></small>
                            </p>
                            {% if drug.min_price and drug.max_price %}
                            <p class="card-text">
                                <span class="text-success fw-bold">Â¥{{ "%.2f"|format(drug.min_price) }}</span>
                                ~
                                <span class="text-danger">Â¥{{ "%.2f"|format(drug.max_price) }}</span>
                            </p>
                            {% else %}
                            <p class="card-text text-muted">æš‚æ— ä»·æ ¼</p>
                            {% endif %}
                            {% if drug.last_crawled %}
                            <p class="card-text">
                                <small class="text-muted">ğŸ•’ {{ drug.last_crawled[:16] }}</small>
                            </p>
                            {% endif %}
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="{{ url_for('main.drug_detail', drug_id=drug.id) }}" class="btn btn-sm btn-primary">
                                æŸ¥çœ‹è¯¦æƒ…
                            </a>
                            <a href="{{ url_for('main.compare') }}?drug={{ drug.name }}" class="btn btn-sm btn-outline-secondary">
                                æ¯”ä»·
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12 text-center py-5">
                    <p class="text-muted">
                        {% if keyword %}
                        æœªæ‰¾åˆ°åŒ…å« "{{ keyword }}" çš„è¯å“
                        {% else %}
                        æš‚æ— è¯å“æ•°æ®ï¼Œè¯·å…ˆ<a href="{{ url_for('main.crawl') }}">é‡‡é›†è¯å“</a>
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>
        {% else %}
        <!-- è¡¨æ ¼è§†å›¾ -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 5%;">ID</th>
                                <th style="width: 35%;">è¯å“åç§°</th>
                                <th style="width: 15%;">è§„æ ¼</th>
                                <th style="width: 10%;">ä»·æ ¼æ•°é‡</th>
                                <th style="width: 15%;">ä»·æ ¼èŒƒå›´</th>
                                <th style="width: 15%;">æœ€åé‡‡é›†</th>
                                <th style="width: 5%;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if drugs %}
                                {% for drug in drugs %}
                                <tr>
                                    <td>{{ drug.id }}</td>
                                    <td>
                                        <strong>{{ drug.name }}</strong>
                                        {% if drug.manufacturer %}
                                        <br><small class="text-muted">{{ drug.manufacturer }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ drug.specification or '-' }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ drug.price_count }}</span>
                                    </td>
                                    <td>
                                        {% if drug.min_price and drug.max_price %}
                                            <span class="text-success">Â¥{{ "%.2f"|format(drug.min_price) }}</span>
                                            ~
                                            <span class="text-danger">Â¥{{ "%.2f"|format(drug.max_price) }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if drug.last_crawled %}
                                            <small>{{ drug.last_crawled[:16] }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('main.drug_detail', drug_id=drug.id) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            æŸ¥çœ‹
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        {% if keyword %}
                                        æœªæ‰¾åˆ°åŒ…å« "{{ keyword }}" çš„è¯å“
                                        {% else %}
                                        æš‚æ— è¯å“æ•°æ®ï¼Œè¯·å…ˆ<a href="{{ url_for('main.crawl') }}">é‡‡é›†è¯å“</a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- åˆ†é¡µ -->
{% if pages > 1 %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        <!-- ä¸Šä¸€é¡µ -->
        <li class="page-item {{ 'disabled' if page == 1 else '' }}">
            <a class="page-link" href="{{ url_for('main.drugs_list', page=page-1, sort=sort_by, q=keyword, view=view_mode) if page > 1 else '#' }}">
                ä¸Šä¸€é¡µ
            </a>
        </li>
        
        <!-- é¡µç  -->
        {% set start_page = [1, page - 2]|max %}
        {% set end_page = [pages, page + 2]|min %}
        
        {% if start_page > 1 %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('main.drugs_list', page=1, sort=sort_by, q=keyword, view=view_mode) }}">1</a>
            </li>
            {% if start_page > 2 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endif %}
        
        {% for p in range(start_page, end_page + 1) %}
            <li class="page-item {{ 'active' if p == page else '' }}">
                <a class="page-link" href="{{ url_for('main.drugs_list', page=p, sort=sort_by, q=keyword, view=view_mode) }}">{{ p }}</a>
            </li>
        {% endfor %}
        
        {% if end_page < pages %}
            {% if end_page < pages - 1 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('main.drugs_list', page=pages, sort=sort_by, q=keyword, view=view_mode) }}">{{ pages }}</a>
            </li>
        {% endif %}
        
        <!-- ä¸‹ä¸€é¡µ -->
        <li class="page-item {{ 'disabled' if page == pages else '' }}">
            <a class="page-link" href="{{ url_for('main.drugs_list', page=page+1, sort=sort_by, q=keyword, view=view_mode) if page < pages else '#' }}">
                ä¸‹ä¸€é¡µ
            </a>
        </li>
    </ul>
</nav>
{% endif %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h5 class="card-title">ğŸ’¡ å¿«æ·æ“ä½œ</h5>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('main.crawl') }}" class="btn btn-primary">
                        ğŸ“¥ é‡‡é›†æ›´å¤šè¯å“
                    </a>
                    <a href="{{ url_for('main.search') }}" class="btn btn-success">
                        ğŸ” æœç´¢è¯å“
                    </a>
                    <a href="{{ url_for('main.index') }}" class="btn btn-info">
                        ğŸ  è¿”å›é¦–é¡µ
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
