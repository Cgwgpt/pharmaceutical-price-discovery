{% extends "base.html" %}

{% block title %}æ¯”ä»· - {{ drug_name or 'è¯å“æ¯”ä»·' }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h4>ğŸ“Š è¯å“æ¯”ä»·</h4>
        
        <!-- åŠŸèƒ½è¯´æ˜æç¤º -->
        <div class="alert alert-info py-2 mb-3" style="font-size: 13px;">
            <strong>ğŸ’¡ åŠŸèƒ½è¯´æ˜ï¼š</strong>
            <ul class="mb-0 mt-1" style="font-size: 12px;">
                <li><strong>æ¯”ä»·åŠŸèƒ½</strong>ç”¨äºæ¯”è¾ƒ<strong>ä¸åŒå¹³å°</strong>ï¼ˆå¦‚è¯å¸ˆå¸®ã€äº¬ä¸œã€å¤©çŒ«ç­‰ï¼‰çš„ä»·æ ¼</li>
                <li>å¦‚éœ€æŸ¥çœ‹<strong>åŒä¸€è¯å“çš„ä¸åŒä¾›åº”å•†ä»·æ ¼</strong>ï¼Œè¯·ä½¿ç”¨<a href="{{ url_for('main.search') }}" class="alert-link">æœç´¢åŠŸèƒ½</a> â†’ ç‚¹å‡»è¯å“æŸ¥çœ‹è¯¦æƒ…</li>
                <li>ç›®å‰ç³»ç»Ÿä»…é‡‡é›†äº†è¯å¸ˆå¸®å¹³å°çš„æ•°æ®ï¼Œæš‚ä¸æ”¯æŒè·¨å¹³å°æ¯”ä»·</li>
            </ul>
        </div>
        
        <form action="{{ url_for('main.compare') }}" method="get" class="mt-3">
            <div class="input-group" style="max-width: 500px;">
                <input type="text" class="form-control" name="drug" 
                       value="{{ drug_name }}" placeholder="è¾“å…¥è¯å“åç§°è¿›è¡Œæ¯”ä»·">
                <button class="btn btn-primary" type="submit">æ¯”ä»·</button>
            </div>
        </form>
    </div>
</div>

{% if comparison %}
<!-- æ¯”ä»·æ‘˜è¦ - åªæ˜¾ç¤ºæœ€ä¼˜äº§å“çš„ä¿¡æ¯ -->
{% if comparison.product_groups and comparison.product_groups|length > 0 %}
{% set best_group = comparison.product_groups[0] %}
{% set best_product = best_group.manufacturers[0] if best_group.manufacturers else none %}
{% if best_product %}
<div class="alert alert-success mb-4">
    <h5 class="mb-2">ğŸ† æœ€ä¼˜é€‰æ‹©ï¼š{{ best_group.common_name }}</h5>
    <p class="mb-0">
        å‚å®¶ï¼š{{ best_product.manufacturer }} | 
        è§„æ ¼ï¼š{{ best_product.specification or '-' }} | 
        ä»·æ ¼ï¼š<strong>Â¥{{ "%.2f"|format(best_product.min_price) }}</strong>
        {% if best_product.min_price != best_product.max_price %}
        ~ Â¥{{ "%.2f"|format(best_product.max_price) }}
        ï¼ˆä»·å·® {{ best_product.price_diff_percent }}%ï¼‰
        {% endif %}
        | ä¾›åº”å•†ï¼š{{ best_product.supplier_count }}å®¶
    </p>
</div>
{% endif %}
{% endif %}

<!-- æŒ‰è§„æ ¼åˆ†ç»„çš„äº§å“æ¯”ä»· -->
{% if comparison.product_groups %}
{% for group in comparison.product_groups %}
{% set all_min_prices = group.manufacturers | map(attribute='min_price') | list %}
{% set all_max_prices = group.manufacturers | map(attribute='max_price') | list %}
{% set group_min = all_min_prices | min %}
{% set group_max = all_max_prices | max %}
{% set group_diff = group_max - group_min %}
{% set group_diff_percent = ((group_max - group_min) / group_min * 100) | round(2) if group_min > 0 else 0 %}

<div class="card mb-4">
    <div class="card-header {% if loop.first %}bg-success text-white{% else %}bg-secondary text-white{% endif %}">
        <h5 class="mb-0">
            {% if loop.first %}ğŸ†{% else %}ğŸ“¦{% endif %} 
            {{ group.display_name or (group.common_name ~ ' ' ~ group.specification) }}
            {% if group.manufacturer_count > 1 %}
            <span class="badge bg-light text-dark ms-2">{{ group.manufacturer_count }} ä¸ªå‚å®¶å¯é€‰</span>
            {% endif %}
        </h5>
        {% if loop.first %}
        <small>æœ€ä¼˜è§„æ ¼</small>
        {% else %}
        <small>å…¶ä»–è§„æ ¼</small>
        {% endif %}
    </div>
    
    <!-- è¯¥è§„æ ¼çš„ä»·æ ¼æ‘˜è¦ -->
    <div class="card-body border-bottom bg-light">
        <div class="row text-center">
            <div class="col-3">
                <div class="text-success">
                    <h5 class="mb-0">Â¥{{ "%.2f"|format(group_min) }}</h5>
                    <small>æœ€ä½ä»·</small>
                </div>
            </div>
            <div class="col-3">
                <div class="text-danger">
                    <h5 class="mb-0">Â¥{{ "%.2f"|format(group_max) }}</h5>
                    <small>æœ€é«˜ä»·</small>
                </div>
            </div>
            <div class="col-3">
                <div class="text-warning">
                    <h5 class="mb-0">{{ group_diff_percent }}%</h5>
                    <small>ä»·å·®</small>
                </div>
            </div>
            <div class="col-3">
                <div class="text-info">
                    <h5 class="mb-0">Â¥{{ "%.2f"|format(group_diff) }}</h5>
                    <small>å¯èŠ‚çœ</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>æ¨è</th>
                        <th>ç”Ÿäº§å‚å®¶</th>
                        <th>è§„æ ¼</th>
                        <th>æœ€ä½ä»·</th>
                        <th>æœ€é«˜ä»·</th>
                        <th>ä»·å·®</th>
                        <th>ä¾›åº”å•†æ•°</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in group.manufacturers %}
                    <tr {% if product.is_best_choice %}class="table-success"{% endif %}>
                        <td>
                            {% if product.is_best_choice %}
                            <span class="badge bg-success">âœ“ æœ€ä¼˜</span>
                            {% else %}
                            <span class="badge bg-secondary">å¯é€‰</span>
                            {% endif %}
                        </td>
                        <td>{{ product.manufacturer[:20] }}{% if product.manufacturer|length > 20 %}...{% endif %}</td>
                        <td>{{ product.specification or '-' }}</td>
                        <td class="text-success fw-bold">Â¥{{ "%.2f"|format(product.min_price) }}</td>
                        <td class="text-danger">Â¥{{ "%.2f"|format(product.max_price) }}</td>
                        <td>
                            {% if product.price_diff_percent > 0 %}
                            <span class="badge bg-warning text-dark">{{ product.price_diff_percent }}%</span>
                            {% else %}
                            <span class="badge bg-secondary">0%</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ product.supplier_count }}å®¶
                            {% if product.prices and product.prices[0].source_url %}
                            <a href="{{ product.prices[0].source_url }}" target="_blank" class="ms-1" title="åœ¨è¯å¸ˆå¸®æŸ¥çœ‹è¯¦æƒ…">
                                <small>ğŸ”—</small>
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endfor %}
{% endif %}

<!-- è¯¦ç»†ä»·æ ¼åˆ—è¡¨ -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">ğŸ“‹ è¯¦ç»†ä»·æ ¼åˆ—è¡¨ï¼ˆå…± {{ comparison.total_records }} æ¡ï¼‰</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>è¯å“åç§°</th>
                        <th>è§„æ ¼</th>
                        <th>å‚å®¶</th>
                        <th>ä»·æ ¼</th>
                        <th>æ¥æº</th>
                        <th>æ›´æ–°æ—¶é—´</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in comparison.prices %}
                    <tr {% if item.is_lowest %}class="table-success"{% endif %}>
                        <td>
                            {% if item.is_lowest %}
                            <span class="badge bg-success">æœ€ä½ä»·</span>
                            {% else %}
                            {{ loop.index }}
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('main.drug_detail', drug_id=item.drug_id) }}">
                                {{ item.drug_name[:30] }}{% if item.drug_name|length > 30 %}...{% endif %}
                            </a>
                        </td>
                        <td>{{ item.specification or '-' }}</td>
                        <td>{{ (item.manufacturer or '-')[:15] }}{% if item.manufacturer and item.manufacturer|length > 15 %}...{% endif %}</td>
                        <td class="{% if item.is_lowest %}text-success fw-bold{% else %}text-danger{% endif %}">
                            Â¥{{ "%.2f"|format(item.price) }}
                        </td>
                        <td>
                            <a href="{{ item.source_url }}" target="_blank">{{ item.source_name }}</a>
                        </td>
                        <td>{{ item.crawled_at[:10] if item.crawled_at else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% elif drug_name %}
<div class="alert alert-warning">
    <h5 class="mb-2">âš ï¸ æœªæ‰¾åˆ°"{{ drug_name }}"çš„ä»·æ ¼æ•°æ®</h5>
    <p class="mb-2">å¯èƒ½çš„åŸå› ï¼š</p>
    <ul class="mb-2" style="font-size: 13px;">
        <li>è¯¥è¯å“å°šæœªé‡‡é›†æ•°æ®</li>
        <li>ç›®å‰ç³»ç»Ÿä»…æ”¯æŒè¯å¸ˆå¸®å¹³å°çš„æ•°æ®ï¼Œä¸æ”¯æŒè·¨å¹³å°æ¯”ä»·</li>
    </ul>
    <p class="mb-0">
        <strong>å»ºè®®æ“ä½œï¼š</strong>
        <a href="{{ url_for('main.search') }}?q={{ drug_name }}" class="alert-link">å‰å¾€æœç´¢é¡µé¢</a>æŸ¥çœ‹è¯¥è¯å“çš„ä¾›åº”å•†ä»·æ ¼ï¼Œ
        æˆ–<a href="{{ url_for('main.crawl') }}" class="alert-link">å‰å¾€é‡‡é›†é¡µé¢</a>é‡‡é›†è¯¥è¯å“æ•°æ®
    </p>
</div>
{% else %}
<div class="text-center py-5 text-muted">
    <p>è¯·è¾“å…¥è¯å“åç§°å¼€å§‹æ¯”ä»·</p>
</div>
{% endif %}
{% endblock %}
