{% extends "base.html" %}

{% block title %}é‡‡é›†ç®¡ç† - åŒ»è¯ä»·æ ¼å‘ç°ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>ğŸ“¥ é‡‡é›†ç®¡ç†</h2>
        <p class="text-muted">ç®¡ç†è¯å“ç›‘æ§åˆ—è¡¨ï¼Œæ‰§è¡Œæ‰¹é‡é‡‡é›†ä»»åŠ¡</p>
    </div>
</div>

<!-- Tokené…ç½®å¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span>ğŸ”‘ è¯å¸ˆå¸®è´¦å·é…ç½®ï¼ˆå¿…é¡»å…ˆé…ç½®æ‰èƒ½é‡‡é›†ï¼‰</span>
                <span class="badge" id="tokenStatus">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-7">
                        <div class="alert alert-warning py-2 mb-2">
                            <strong>ğŸ“‹ è¯·ç²˜è´´Tokenæˆ–å®Œæ•´Cookie</strong>ï¼ˆä»æµè§ˆå™¨å¤åˆ¶ï¼‰
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="manualToken" 
                                   placeholder="ç²˜è´´Tokenï¼ˆå¦‚: 6eb9c20b...ï¼‰æˆ–å®Œæ•´Cookieå­—ç¬¦ä¸²">
                            <button class="btn btn-primary" onclick="saveManualToken()">
                                ğŸ’¾ ä¿å­˜Token
                            </button>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="card bg-light">
                            <div class="card-body py-2" style="font-size: 12px;">
                                <strong>ğŸ“– è·å–Tokenæ­¥éª¤ï¼š</strong>
                                <ol class="mb-0 ps-3">
                                    <li>æ‰“å¼€ <a href="https://dian.ysbang.cn" target="_blank">dian.ysbang.cn</a> å¹¶ç™»å½•</li>
                                    <li>æŒ‰ <kbd>F12</kbd> â†’ Network æ ‡ç­¾</li>
                                    <li>åˆ·æ–°é¡µé¢ï¼Œç‚¹å‡»ä»»æ„è¯·æ±‚</li>
                                    <li>åœ¨ Headers æ‰¾åˆ° <code>Token:</code> åçš„å€¼</li>
                                    <li>å¤åˆ¶ç²˜è´´åˆ°å·¦è¾¹è¾“å…¥æ¡†</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3>{{ statistics.watch_list_count }}</h3>
                <small>ç›‘æ§è¯å“æ•°</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ statistics.completed_tasks }}</h3>
                <small>å·²å®Œæˆä»»åŠ¡</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>{{ statistics.total_items_crawled }}</h3>
                <small>ç´¯è®¡é‡‡é›†æ•°æ®</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h3>{{ statistics.today_items }}</h3>
                <small>ä»Šæ—¥é‡‡é›†</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- å·¦ä¾§ï¼šç›‘æ§åˆ—è¡¨ç®¡ç† -->
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>ğŸ“‹ è¯å“ç›‘æ§åˆ—è¡¨</span>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addDrugModal">
                    + æ·»åŠ è¯å“
                </button>
            </div>
            <div class="card-body">
                <!-- åˆ†ç±»ç­›é€‰ -->
                <div class="mb-3">
                    <select class="form-select form-select-sm" id="categoryFilter">
                        <option value="">å…¨éƒ¨åˆ†ç±»</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- ç›‘æ§åˆ—è¡¨ -->
                <div class="list-group" id="watchList" style="max-height: 400px; overflow-y: auto;">
                    {% if watch_list %}
                        {% for item in watch_list %}
                        <div class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ item.id }}">
                            <div>
                                <strong>{{ item.keyword }}</strong>
                                {% if item.category %}
                                <span class="badge bg-secondary ms-1">{{ item.category }}</span>
                                {% endif %}
                                {% if item.priority == 2 %}
                                <span class="badge bg-danger ms-1">ç´§æ€¥</span>
                                {% elif item.priority == 1 %}
                                <span class="badge bg-warning text-dark ms-1">é‡è¦</span>
                                {% endif %}
                                <br>
                                <small class="text-muted">
                                    é‡‡é›†{{ item.crawl_count }}æ¬¡
                                    {% if item.last_crawled_at %}
                                    | æœ€å: {{ item.last_crawled_at[:10] }}
                                    {% endif %}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFromWatchList({{ item.id }})">
                                âœ•
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            æš‚æ— ç›‘æ§è¯å“ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ 
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- è¯å“é‡‡é›† -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                ğŸ¯ è¯å“é‡‡é›†
            </div>
            <div class="card-body">
                <!-- é‡‡é›†ç±»å‹é€‰æ‹© -->
                <div class="mb-4">
                    <label class="form-label fw-bold">é‡‡é›†ç±»å‹</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="crawlType" id="singleCrawl" value="single" checked>
                        <label class="btn btn-outline-primary" for="singleCrawl">
                            ğŸ¯ å•ä¸ªè¯å“
                        </label>
                        
                        <input type="radio" class="btn-check" name="crawlType" id="batchCrawl" value="batch">
                        <label class="btn btn-outline-success" for="batchCrawl">
                            ğŸ“¦ æ‰¹é‡é‡‡é›†
                        </label>
                    </div>
                    <small class="text-muted d-block mt-2" id="crawlTypeHint">
                        é‡‡é›†å•ä¸ªå…·ä½“è¯å“çš„æ‰€æœ‰ä¾›åº”å•†ä»·æ ¼
                    </small>
                </div>
                
                <!-- å•ä¸ªè¯å“é‡‡é›†åŒºåŸŸ -->
                <div id="singleCrawlArea">
                    <div class="alert alert-info py-2 mb-3" style="font-size: 12px;">
                        <strong>ğŸ’¡ ä¸‰ç§é‡‡é›†æ¨¡å¼ï¼š</strong>
                        <ul class="mb-0 mt-1" style="font-size: 11px;">
                            <li><strong>âš¡ å¿«é€Ÿæ¨¡å¼</strong>ï¼šAPI è·å–çƒ­é”€ä»·æ ¼ï¼ˆ1-3ç§’ï¼‰</li>
                            <li><strong>ğŸ“Š å®Œæ•´æ¨¡å¼</strong>ï¼šè·å–æ‰€æœ‰ä¾›åº”å•†ä»·æ ¼ï¼ˆ10-30ç§’ï¼‰</li>
                            <li><strong>ğŸ§  æ™ºèƒ½æ¨¡å¼</strong>ï¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆï¼ˆæ¨èï¼‰</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">è¯å“åç§°</label>
                        <input type="text" class="form-control" id="modeKeyword" 
                               placeholder="è¾“å…¥è¯å“åç§°ï¼Œå¦‚ï¼šå¤©éº»èœœç¯èŒç‰‡">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">è¯å“IDï¼ˆå¯é€‰ï¼‰
                            <a href="#" data-bs-toggle="modal" data-bs-target="#drugIdHelpModal" class="text-decoration-none ms-1">
                                <small>â“ å¦‚ä½•è·å–ï¼Ÿ</small>
                            </a>
                        </label>
                        <input type="number" class="form-control" id="modeDrugId" 
                               placeholder="ç•™ç©ºå³å¯ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æœç´¢">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">é‡‡é›†æ¨¡å¼</label>
                        <select class="form-select" id="crawlMode">
                            <option value="smart" selected>ğŸ§  æ™ºèƒ½æ¨¡å¼ - è‡ªåŠ¨é€‰æ‹©ï¼ˆæ¨èï¼‰</option>
                            <option value="quick">âš¡ å¿«é€Ÿæ¨¡å¼ - API çƒ­é”€ä»·æ ¼</option>
                            <option value="complete">ğŸ“Š å®Œæ•´æ¨¡å¼ - æ‰€æœ‰ä¾›åº”å•†ä»·æ ¼</option>
                        </select>
                    </div>
                    
                    <div id="smartOptions" style="display: block;">
                        <div class="mb-3">
                            <label class="form-label">æœ€å°ä¾›åº”å•†æ•°ï¼ˆæ™ºèƒ½æ¨¡å¼ï¼‰</label>
                            <input type="number" class="form-control" id="modeMinProviders" 
                                   value="5" min="1" max="50">
                            <small class="text-muted">ä½äºæ­¤å€¼å°†è‡ªåŠ¨ä½¿ç”¨å®Œæ•´æ¨¡å¼è¡¥å……</small>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary w-100" onclick="crawlWithMode()">
                        ğŸ¯ å¼€å§‹é‡‡é›†
                    </button>
                </div>
                
                <!-- æ‰¹é‡é‡‡é›†åŒºåŸŸ -->
                <div id="batchCrawlArea" style="display: none;">
                    <div class="alert alert-success py-2 mb-3" style="font-size: 12px;">
                        <strong>ğŸ¯ æ‰¹é‡é‡‡é›†è¯´æ˜ï¼š</strong>
                        <ul class="mb-0 mt-1" style="font-size: 11px;">
                            <li>æœç´¢å…³é”®è¯ï¼Œè·å–æ‰€æœ‰åŒ¹é…çš„è¯å“</li>
                            <li>é€ä¸ªé‡‡é›†æ¯ä¸ªè¯å“çš„ä¾›åº”å•†ä»·æ ¼</li>
                            <li>é€‚åˆé‡‡é›†æŸä¸ªå“ç±»çš„å®Œæ•´æ•°æ®</li>
                            <li>ä¾‹å¦‚ï¼šæœç´¢"å¤©éº»èœœç¯èŒç‰‡"ï¼Œé‡‡é›†æ‰€æœ‰å“ç‰Œ/è§„æ ¼</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">æœç´¢å…³é”®è¯</label>
                        <input type="text" class="form-control" id="batchKeyword" 
                               placeholder="è¾“å…¥è¯å“åç§°ï¼Œå¦‚ï¼šå¤©éº»èœœç¯èŒç‰‡">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">æœ€å¤šé‡‡é›†è¯å“æ•°</label>
                        <input type="number" class="form-control" id="batchMaxDrugs" 
                               value="10" min="1" max="50">
                        <small class="text-muted">å»ºè®®10-20ä¸ªï¼Œé¿å…æ—¶é—´è¿‡é•¿</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">æ¯ä¸ªè¯å“æœ€å¤šé‡‡é›†ä¾›åº”å•†æ•°</label>
                        <input type="number" class="form-control" id="batchMaxProviders" 
                               value="50" min="10" max="200">
                    </div>
                    
                    <button class="btn btn-success w-100" onclick="batchCrawlSearch()">
                        ğŸ“¦ å¼€å§‹æ‰¹é‡é‡‡é›†
                    </button>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            â±ï¸ é¢„è®¡è€—æ—¶ï¼šçº¦ (è¯å“æ•° Ã— 15ç§’)ï¼Œ10ä¸ªè¯å“çº¦2.5åˆ†é’Ÿ
                        </small>
                    </div>
                </div>
            </div>
        </div>
        

    </div>
    
    <!-- å³ä¾§ï¼šé‡‡é›†ä»»åŠ¡ -->
    <div class="col-md-7">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>ğŸ“Š é‡‡é›†ä»»åŠ¡</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshTasks()">åˆ·æ–°</button>
                    <button class="btn btn-sm btn-primary" onclick="createTaskFromWatchList()">
                        ä»ç›‘æ§åˆ—è¡¨åˆ›å»ºä»»åŠ¡
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ä»»åŠ¡åç§°</th>
                                <th>çŠ¶æ€</th>
                                <th>è¿›åº¦</th>
                                <th>é‡‡é›†æ•°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="taskList">
                            {% for task in tasks %}
                            <tr data-task-id="{{ task.id }}">
                                <td>
                                    <strong>{{ task.task_name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ task.created_at[:16] if task.created_at else '' }}</small>
                                </td>
                                <td>
                                    {% if task.status == 'running' %}
                                    <span class="badge bg-primary">è¿è¡Œä¸­</span>
                                    {% elif task.status == 'completed' %}
                                    <span class="badge bg-success">å·²å®Œæˆ</span>
                                    {% elif task.status == 'failed' %}
                                    <span class="badge bg-danger">å¤±è´¥</span>
                                    {% elif task.status == 'cancelled' %}
                                    <span class="badge bg-secondary">å·²å–æ¶ˆ</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">ç­‰å¾…ä¸­</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" style="width: {{ task.progress }}%">
                                            {{ task.progress }}%
                                        </div>
                                    </div>
                                    <small>{{ task.completed_keywords }}/{{ task.total_keywords }}</small>
                                </td>
                                <td>{{ task.total_items }}</td>
                                <td>
                                    {% if task.status == 'pending' %}
                                    <button class="btn btn-sm btn-success" onclick="startTask({{ task.id }})">å¯åŠ¨</button>
                                    {% elif task.status == 'running' %}
                                    <button class="btn btn-sm btn-danger" onclick="cancelTask({{ task.id }})">å–æ¶ˆ</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">æš‚æ— é‡‡é›†ä»»åŠ¡</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- é‡‡é›†ç»“æœ -->
        <div class="card">
            <div class="card-header">ğŸ“ é‡‡é›†æ—¥å¿—</div>
            <div class="card-body">
                <div id="crawlLog" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px;">
                    <div class="text-muted">ç­‰å¾…é‡‡é›†ä»»åŠ¡...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ è¯å“æ¨¡æ€æ¡† -->
<div class="modal fade" id="addDrugModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ·»åŠ è¯å“åˆ°ç›‘æ§åˆ—è¡¨</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">è¯å“åç§°</label>
                    <textarea class="form-control" id="addKeywords" rows="4" 
                              placeholder="è¾“å…¥è¯å“åç§°ï¼Œæ¯è¡Œä¸€ä¸ª"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">åˆ†ç±»</label>
                    <input type="text" class="form-control" id="addCategory" 
                           placeholder="å¦‚ï¼šæ„Ÿå†’è¯ã€æŠ—ç”Ÿç´ ã€å¿ƒè¡€ç®¡">
                </div>
                <div class="mb-3">
                    <label class="form-label">ä¼˜å…ˆçº§</label>
                    <select class="form-select" id="addPriority">
                        <option value="0">æ™®é€š</option>
                        <option value="1">é‡è¦</option>
                        <option value="2">ç´§æ€¥</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="addToWatchList()">æ·»åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- è¯å“IDå¸®åŠ©æ¨¡æ€æ¡† -->
<div class="modal fade" id="drugIdHelpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">ğŸ“– å¦‚ä½•è·å–è¯å“IDï¼ˆdrugIdï¼‰ï¼Ÿ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‚¨<strong>ä¸éœ€è¦</strong>æä¾›è¯å“IDï¼
                    <br>åªéœ€è¾“å…¥è¯å“åç§°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æœç´¢å¹¶é‡‡é›†ã€‚
                </div>
                
                <h6 class="mt-4">ğŸ¯ ä»€ä¹ˆæ—¶å€™éœ€è¦è¯å“IDï¼Ÿ</h6>
                <ul>
                    <li>å½“æœç´¢ç»“æœæœ‰å¤šä¸ªåŒåè¯å“æ—¶ï¼Œéœ€è¦æŒ‡å®šå…·ä½“å“ªä¸€ä¸ª</li>
                    <li>å½“æ‚¨å·²ç»çŸ¥é“å‡†ç¡®çš„drugIdï¼Œæƒ³è¦æ›´å¿«é€Ÿç²¾ç¡®çš„é‡‡é›†</li>
                </ul>
                
                <h6 class="mt-4">ğŸ“‹ è·å–æ­¥éª¤ï¼š</h6>
                <ol>
                    <li><strong>æ‰“å¼€è¯å¸ˆå¸®ç½‘ç«™</strong>
                        <br><a href="https://dian.ysbang.cn" target="_blank">https://dian.ysbang.cn</a>
                    </li>
                    <li><strong>æœç´¢è¯å“</strong>
                        <br>åœ¨æœç´¢æ¡†è¾“å…¥è¯å“åç§°ï¼Œå¦‚"å¤©éº»èœœç¯èŒç‰‡"
                    </li>
                    <li><strong>ç‚¹å‡»è¿›å…¥è¯å“è¯¦æƒ…é¡µ</strong>
                        <br>ä»æœç´¢ç»“æœä¸­é€‰æ‹©æ‚¨è¦çš„è¯å“
                    </li>
                    <li><strong>æŸ¥çœ‹æµè§ˆå™¨åœ°å€æ </strong>
                        <br>URLæ ¼å¼ï¼š<code>https://dian.ysbang.cn/goods/detail?drugId=<span class="text-danger">12345</span></code>
                        <br>çº¢è‰²æ•°å­—éƒ¨åˆ†å°±æ˜¯ drugId
                    </li>
                    <li><strong>å¤åˆ¶drugId</strong>
                        <br>å°†æ•°å­—å¤åˆ¶åˆ°"è¯å“ID"è¾“å…¥æ¡†
                    </li>
                </ol>
                
                <h6 class="mt-4">ğŸ” ç¤ºä¾‹ï¼š</h6>
                <div class="card bg-light">
                    <div class="card-body">
                        <p class="mb-2"><strong>è¯å“ï¼š</strong>å¤©éº»èœœç¯èŒç‰‡</p>
                        <p class="mb-2"><strong>URLï¼š</strong><code>https://dian.ysbang.cn/goods/detail?drugId=4363</code></p>
                        <p class="mb-0"><strong>drugIdï¼š</strong><span class="badge bg-primary">4363</span></p>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4">
                    <strong>âš ï¸ æ³¨æ„ï¼š</strong>
                    <ul class="mb-0">
                        <li>ä¸åŒè§„æ ¼ã€ä¸åŒå‚å®¶çš„åŒåè¯å“ï¼ŒdrugId ä¸åŒ</li>
                        <li>å¦‚æœä¸ç¡®å®šï¼Œå»ºè®®ç•™ç©ºï¼Œè®©ç³»ç»Ÿè‡ªåŠ¨æœç´¢</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">çŸ¥é“äº†</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// æ·»åŠ åˆ°ç›‘æ§åˆ—è¡¨
function addToWatchList() {
    const keywords = document.getElementById('addKeywords').value.trim().split('\n').filter(k => k.trim());
    const category = document.getElementById('addCategory').value.trim();
    const priority = parseInt(document.getElementById('addPriority').value);
    
    if (keywords.length === 0) {
        alert('è¯·è¾“å…¥è¯å“åç§°');
        return;
    }
    
    fetch('/api/crawl/watch-list', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({keywords, category: category || null, priority})
    })
    .then(r => r.json())
    .then(data => {
        if (data.code === 0) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    });
}

// ä»ç›‘æ§åˆ—è¡¨ç§»é™¤
function removeFromWatchList(id) {
    if (!confirm('ç¡®å®šè¦ç§»é™¤å—ï¼Ÿ')) return;
    
    fetch(`/api/crawl/watch-list/${id}`, {method: 'DELETE'})
    .then(r => r.json())
    .then(data => {
        if (data.code === 0) {
            document.querySelector(`[data-id="${id}"]`).remove();
        }
    });
}

// ä»ç›‘æ§åˆ—è¡¨åˆ›å»ºä»»åŠ¡
function createTaskFromWatchList() {
    const category = document.getElementById('categoryFilter').value;
    
    fetch('/api/crawl/tasks', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({use_watch_list: true, category: category || null})
    })
    .then(r => r.json())
    .then(data => {
        if (data.code === 0) {
            addLog(`âœ… ä»»åŠ¡å·²åˆ›å»º: ${data.data.task_name}`);
            refreshTasks();
        } else {
            alert(data.message);
        }
    });
}

// å¯åŠ¨ä»»åŠ¡
function startTask(taskId) {
    fetch(`/api/crawl/tasks/${taskId}/start`, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        addLog(data.message);
        if (data.code === 0) {
            startTaskPolling(taskId);
        }
    });
}

// å–æ¶ˆä»»åŠ¡
function cancelTask(taskId) {
    if (!confirm('ç¡®å®šè¦å–æ¶ˆä»»åŠ¡å—ï¼Ÿ')) return;
    
    fetch(`/api/crawl/tasks/${taskId}/cancel`, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        addLog(data.message);
        refreshTasks();
    });
}

// å¿«é€Ÿé‡‡é›†
function quickCrawl() {
    const keywords = document.getElementById('quickKeywords').value.trim().split('\n').filter(k => k.trim());
    
    if (keywords.length === 0) {
        alert('è¯·è¾“å…¥è¯å“åç§°');
        return;
    }
    
    addLog(`ğŸš€ å¼€å§‹å¿«é€Ÿé‡‡é›†: ${keywords.join(', ')}`);
    
    fetch('/api/crawl/quick', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({keywords})
    })
    .then(r => r.json())
    .then(data => {
        if (data.code === 0) {
            const result = data.data;
            addLog(`âœ… é‡‡é›†å®Œæˆ: å…±${result.total_items}æ¡æ•°æ®`);
            result.results.forEach(r => {
                addLog(`  - ${r.keyword}: ${r.items_count}æ¡ ${r.success ? 'âœ“' : 'âœ—'}`);
            });
        } else {
            addLog(`âŒ é‡‡é›†å¤±è´¥: ${data.message}`);
        }
    });
}

// åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
function refreshTasks() {
    fetch('/api/crawl/tasks')
    .then(r => r.json())
    .then(data => {
        if (data.code === 0) {
            updateTaskTable(data.data);
        }
    });
}

// æ›´æ–°ä»»åŠ¡è¡¨æ ¼
function updateTaskTable(tasks) {
    const tbody = document.getElementById('taskList');
    if (tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— é‡‡é›†ä»»åŠ¡</td></tr>';
        return;
    }
    
    tbody.innerHTML = tasks.map(task => `
        <tr data-task-id="${task.id}">
            <td>
                <strong>${task.task_name}</strong><br>
                <small class="text-muted">${task.created_at ? task.created_at.slice(0, 16) : ''}</small>
            </td>
            <td>${getStatusBadge(task.status)}</td>
            <td>
                <div class="progress" style="width: 100px;">
                    <div class="progress-bar" style="width: ${task.progress}%">${task.progress}%</div>
                </div>
                <small>${task.completed_keywords}/${task.total_keywords}</small>
            </td>
            <td>${task.total_items}</td>
            <td>${getTaskActions(task)}</td>
        </tr>
    `).join('');
}

function getStatusBadge(status) {
    const badges = {
        'running': '<span class="badge bg-primary">è¿è¡Œä¸­</span>',
        'completed': '<span class="badge bg-success">å·²å®Œæˆ</span>',
        'failed': '<span class="badge bg-danger">å¤±è´¥</span>',
        'cancelled': '<span class="badge bg-secondary">å·²å–æ¶ˆ</span>',
        'pending': '<span class="badge bg-warning text-dark">ç­‰å¾…ä¸­</span>'
    };
    return badges[status] || status;
}

function getTaskActions(task) {
    if (task.status === 'pending') {
        return `<button class="btn btn-sm btn-success" onclick="startTask(${task.id})">å¯åŠ¨</button>`;
    } else if (task.status === 'running') {
        return `<button class="btn btn-sm btn-danger" onclick="cancelTask(${task.id})">å–æ¶ˆ</button>`;
    }
    return '';
}

// ä»»åŠ¡è¿›åº¦è½®è¯¢
let pollingInterval = null;
function startTaskPolling(taskId) {
    if (pollingInterval) clearInterval(pollingInterval);
    
    pollingInterval = setInterval(() => {
        fetch(`/api/crawl/tasks/${taskId}`)
        .then(r => r.json())
        .then(data => {
            if (data.code === 0) {
                const task = data.data;
                addLog(`ğŸ“Š è¿›åº¦: ${task.completed_keywords}/${task.total_keywords} (${task.progress}%)`);
                refreshTasks();
                
                if (task.status !== 'running') {
                    clearInterval(pollingInterval);
                    addLog(`ğŸ ä»»åŠ¡${task.status === 'completed' ? 'å®Œæˆ' : 'ç»“æŸ'}: å…±é‡‡é›†${task.total_items}æ¡æ•°æ®`);
                }
            }
        });
    }, 3000);
}

// æ·»åŠ æ—¥å¿—
function addLog(message) {
    const log = document.getElementById('crawlLog');
    const time = new Date().toLocaleTimeString();
    log.innerHTML += `<div>[${time}] ${message}</div>`;
    log.scrollTop = log.scrollHeight;
}

// åˆ†ç±»ç­›é€‰
document.getElementById('categoryFilter').addEventListener('change', function() {
    const category = this.value;
    fetch(`/api/crawl/watch-list?category=${category}`)
    .then(r => r.json())
    .then(data => {
        if (data.code === 0) {
            updateWatchList(data.data);
        }
    });
});

function updateWatchList(items) {
    const list = document.getElementById('watchList');
    if (items.length === 0) {
        list.innerHTML = '<div class="text-center text-muted py-4">æš‚æ— ç›‘æ§è¯å“</div>';
        return;
    }
    
    list.innerHTML = items.map(item => `
        <div class="list-group-item d-flex justify-content-between align-items-center" data-id="${item.id}">
            <div>
                <strong>${item.keyword}</strong>
                ${item.category ? `<span class="badge bg-secondary ms-1">${item.category}</span>` : ''}
                ${item.priority === 2 ? '<span class="badge bg-danger ms-1">ç´§æ€¥</span>' : ''}
                ${item.priority === 1 ? '<span class="badge bg-warning text-dark ms-1">é‡è¦</span>' : ''}
                <br>
                <small class="text-muted">
                    é‡‡é›†${item.crawl_count}æ¬¡
                    ${item.last_crawled_at ? `| æœ€å: ${item.last_crawled_at.slice(0, 10)}` : ''}
                </small>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="removeFromWatchList(${item.id})">âœ•</button>
        </div>
    `).join('');
}

// åˆå§‹åŒ–
addLog('ğŸ“‹ é‡‡é›†ç®¡ç†é¡µé¢å·²åŠ è½½');
checkTokenStatus();

// æ£€æŸ¥TokençŠ¶æ€
function checkTokenStatus() {
    fetch('/api/crawl/token/status')
    .then(r => r.json())
    .then(data => {
        const badge = document.getElementById('tokenStatus');
        if (data.code === 0 && data.data.valid) {
            badge.className = 'badge bg-success';
            badge.textContent = 'âœ“ Tokenæœ‰æ•ˆ';
            addLog('âœ… TokençŠ¶æ€æ­£å¸¸');
        } else {
            badge.className = 'badge bg-danger';
            badge.textContent = 'âœ— Tokenæ— æ•ˆ';
            addLog('âš ï¸ Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é…ç½®');
        }
    })
    .catch(() => {
        document.getElementById('tokenStatus').className = 'badge bg-warning';
        document.getElementById('tokenStatus').textContent = 'æœªçŸ¥';
    });
}

// è‡ªåŠ¨è·å–Token
function autoGetToken() {
    const phone = document.getElementById('ysbPhone').value.trim();
    const password = document.getElementById('ysbPassword').value.trim();
    
    if (!phone || !password) {
        alert('è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ');
        return;
    }
    
    const btn = document.getElementById('loginBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ ç™»å½•ä¸­...';
    btn.disabled = true;
    
    addLog('ğŸ”„ æ­£åœ¨è‡ªåŠ¨ç™»å½•ï¼Œè¯·ç¨å€™ï¼ˆçº¦10-20ç§’ï¼‰...');
    
    fetch('/api/crawl/token/auto', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({phone, password})
    })
    .then(r => r.json())
    .then(data => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        if (data.code === 0) {
            addLog('âœ… ' + data.message);
            checkTokenStatus();
            alert('ğŸ‰ ç™»å½•æˆåŠŸï¼Tokenå·²è‡ªåŠ¨ä¿å­˜ï¼Œç°åœ¨å¯ä»¥å¼€å§‹é‡‡é›†äº†');
        } else {
            addLog('âŒ ' + data.message);
            alert('ç™»å½•å¤±è´¥: ' + data.message + '\n\nè¯·å°è¯•æ‰‹åŠ¨æ–¹å¼è·å–Token');
        }
    })
    .catch(err => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        addLog('âŒ è¯·æ±‚å¤±è´¥: ' + err);
        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    });
}

// ä¿å­˜æ‰‹åŠ¨Token
function saveManualToken() {
    console.log('saveManualToken å‡½æ•°è¢«è°ƒç”¨');
    
    let token = document.getElementById('manualToken').value.trim();
    
    console.log('Tokenå€¼:', token);
    
    if (!token) {
        alert('è¯·è¾“å…¥Token');
        return;
    }
    
    addLog('ğŸ’¾ æ­£åœ¨ä¿å­˜Token...');
    
    fetch('/api/crawl/token/manual', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({token})
    })
    .then(r => r.json())
    .then(data => {
        console.log('APIå“åº”:', data);
        if (data.code === 0) {
            addLog('âœ… ' + data.message);
            checkTokenStatus();
            alert('ğŸ‰ Tokenä¿å­˜æˆåŠŸï¼ç°åœ¨å¯ä»¥å¼€å§‹é‡‡é›†äº†');
        } else {
            addLog('âŒ ' + data.message);
            alert(data.message);
        }
    })
    .catch(err => {
        console.error('è¯·æ±‚é”™è¯¯:', err);
        addLog('âŒ è¯·æ±‚å¤±è´¥');
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}



// é‡‡é›†æ¨¡å¼é€‰æ‹©
function crawlWithMode() {
    const keyword = document.getElementById('modeKeyword').value.trim();
    const drugId = document.getElementById('modeDrugId').value.trim();
    const mode = document.getElementById('crawlMode').value;
    
    if (!keyword) {
        alert('è¯·è¾“å…¥è¯å“åç§°');
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    
    let endpoint, modeText, modeIcon;
    let body = {
        keyword: keyword,
        drug_id: drugId ? parseInt(drugId) : null
    };
    
    if (mode === 'quick') {
        endpoint = '/api/crawl/quick';
        modeText = 'å¿«é€Ÿæ¨¡å¼';
        modeIcon = 'âš¡';
        btn.innerHTML = 'â³ å¿«é€Ÿé‡‡é›†ä¸­...';
    } else if (mode === 'complete') {
        endpoint = '/api/crawl/complete';
        modeText = 'å®Œæ•´æ¨¡å¼';
        modeIcon = 'ğŸ“Š';
        btn.innerHTML = 'â³ å®Œæ•´é‡‡é›†ä¸­ï¼ˆéœ€10-30ç§’ï¼‰...';
    } else {
        endpoint = '/api/crawl/smart';
        modeText = 'æ™ºèƒ½æ¨¡å¼';
        modeIcon = 'ğŸ§ ';
        const minProviders = parseInt(document.getElementById('modeMinProviders').value) || 5;
        body.min_providers = minProviders;
        btn.innerHTML = 'â³ æ™ºèƒ½é‡‡é›†ä¸­...';
    }
    
    addLog(`${modeIcon} [${modeText}] å¼€å§‹é‡‡é›†: ${keyword}` + (drugId ? ` (drugId=${drugId})` : ''));
    
    fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ¯ å¼€å§‹é‡‡é›†';
        
        if (data.code === 0 && data.data.success) {
            const result = data.data;
            
            addLog(`âœ… [${modeText}] é‡‡é›†æˆåŠŸï¼`);
            addLog(`ğŸ“Š è¯å“: ${keyword}`);
            addLog(`ğŸ“Š æ‰¾åˆ° ${result.providers?.length || 0} ä¸ªä¾›åº”å•†`);
            
            if (result.mode === 'smart') {
                const method = result.method;
                const methodName = method === 'api' ? 'API' : method === 'playwright' ? 'Playwright' : 'API + Playwright';
                addLog(`ğŸ“¡ é‡‡é›†æ–¹å¼: ${methodName}`);
                
                if (result.api_count > 0) {
                    addLog(`  â””â”€ API: ${result.api_count} ä¸ª`);
                }
                if (result.playwright_count > 0) {
                    addLog(`  â””â”€ Playwright: ${result.playwright_count} ä¸ª`);
                }
            }
            
            if (result.saved_count) {
                addLog(`ğŸ’¾ å·²ä¿å­˜ ${result.saved_count} æ¡æ–°ä»·æ ¼è®°å½•åˆ°æ•°æ®åº“`);
                
                // æ·»åŠ æ£€ç´¢é“¾æ¥
                const searchUrl = `/search?q=${encodeURIComponent(keyword)}`;
                addLog(`ğŸ” <a href="${searchUrl}" target="_blank" style="color: #0d6efd; text-decoration: underline;">ç‚¹å‡»è¿™é‡Œæ£€ç´¢æŸ¥çœ‹å·²å…¥åº“çš„è¯å“æ•°æ®</a>`);
            } else if (result.saved_count === 0) {
                addLog(`ğŸ’¾ æ•°æ®å·²å­˜åœ¨ï¼Œæœªæ–°å¢è®°å½•ï¼ˆæ•°æ®åº“ä¸­å·²æœ‰è¿™äº›ä»·æ ¼ï¼‰`);
                
                // å³ä½¿æ•°æ®å·²å­˜åœ¨ï¼Œä¹Ÿæä¾›æ£€ç´¢é“¾æ¥
                const searchUrl = `/search?q=${encodeURIComponent(keyword)}`;
                addLog(`ğŸ” <a href="${searchUrl}" target="_blank" style="color: #0d6efd; text-decoration: underline;">ç‚¹å‡»è¿™é‡Œæ£€ç´¢æŸ¥çœ‹æ•°æ®åº“ä¸­çš„è¯å“æ•°æ®</a>`);
            }
            
            // æ˜¾ç¤ºä¾›åº”å•†ä»·æ ¼
            const providers = result.providers || [];
            if (providers.length > 0) {
                providers.sort((a, b) => (a.price || 0) - (b.price || 0));
                
                addLog(`\nğŸ’° ä¾›åº”å•†ä»·æ ¼ï¼ˆå‰10ä¸ªï¼‰:`);
                providers.slice(0, 10).forEach((p, i) => {
                    const source = p.source ? `[${p.source.toUpperCase()}]` : '';
                    addLog(`  ${i+1}. ${p.provider_name}: Â¥${p.price?.toFixed(2)} ${source}`);
                });
                if (providers.length > 10) {
                    addLog(`  ... è¿˜æœ‰ ${providers.length - 10} ä¸ªä¾›åº”å•†`);
                }
                
                // ä»·æ ¼ç»Ÿè®¡
                const prices = providers.map(p => p.price).filter(p => p > 0);
                if (prices.length > 0) {
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
                    addLog(`\nğŸ“ˆ ä»·æ ¼ç»Ÿè®¡:`);
                    addLog(`  æœ€ä½: Â¥${minPrice.toFixed(2)}`);
                    addLog(`  æœ€é«˜: Â¥${maxPrice.toFixed(2)}`);
                    addLog(`  å¹³å‡: Â¥${avgPrice.toFixed(2)}`);
                    addLog(`  ä»·å·®: Â¥${(maxPrice - minPrice).toFixed(2)} (${((maxPrice - minPrice) / minPrice * 100).toFixed(1)}%)`);
                }
            }
            
            if (result.error) {
                addLog(`âš ï¸ æç¤º: ${result.error}`);
            }
        } else {
            addLog(`âŒ [${modeText}] å¤±è´¥: ${data.message}`);
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ¯ å¼€å§‹é‡‡é›†';
        addLog(`âŒ è¯·æ±‚å¤±è´¥: ${err.message}`);
    });
}

// ç›‘å¬æ¨¡å¼é€‰æ‹©å˜åŒ–
document.addEventListener('DOMContentLoaded', function() {
    const modeSelect = document.getElementById('crawlMode');
    const smartOptions = document.getElementById('smartOptions');
    
    if (modeSelect && smartOptions) {
        modeSelect.addEventListener('change', function() {
            if (this.value === 'smart') {
                smartOptions.style.display = 'block';
            } else {
                smartOptions.style.display = 'none';
            }
        });
    }
    
    // ç›‘å¬é‡‡é›†ç±»å‹åˆ‡æ¢
    const singleCrawlRadio = document.getElementById('singleCrawl');
    const batchCrawlRadio = document.getElementById('batchCrawl');
    const singleCrawlArea = document.getElementById('singleCrawlArea');
    const batchCrawlArea = document.getElementById('batchCrawlArea');
    const crawlTypeHint = document.getElementById('crawlTypeHint');
    
    if (singleCrawlRadio && batchCrawlRadio) {
        singleCrawlRadio.addEventListener('change', function() {
            if (this.checked) {
                singleCrawlArea.style.display = 'block';
                batchCrawlArea.style.display = 'none';
                crawlTypeHint.textContent = 'é‡‡é›†å•ä¸ªå…·ä½“è¯å“çš„æ‰€æœ‰ä¾›åº”å•†ä»·æ ¼';
            }
        });
        
        batchCrawlRadio.addEventListener('change', function() {
            if (this.checked) {
                singleCrawlArea.style.display = 'none';
                batchCrawlArea.style.display = 'block';
                crawlTypeHint.textContent = 'æœç´¢å…³é”®è¯ï¼Œé‡‡é›†æ‰€æœ‰åŒ¹é…è¯å“çš„ä¾›åº”å•†ä»·æ ¼';
            }
        });
    }
});

// æ‰¹é‡é‡‡é›†æœç´¢ç»“æœ
function batchCrawlSearch() {
    const keyword = document.getElementById('batchKeyword').value.trim();
    const maxDrugs = parseInt(document.getElementById('batchMaxDrugs').value) || 10;
    const maxProviders = parseInt(document.getElementById('batchMaxProviders').value) || 50;
    
    if (!keyword) {
        alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = 'â³ æ‰¹é‡é‡‡é›†ä¸­...';
    
    addLog(`ğŸ“¦ [æ‰¹é‡é‡‡é›†] å¼€å§‹: ${keyword}`);
    addLog(`ğŸ“Š å°†é‡‡é›†æœ€å¤š ${maxDrugs} ä¸ªè¯å“ï¼Œæ¯ä¸ªè¯å“æœ€å¤š ${maxProviders} ä¸ªä¾›åº”å•†`);
    addLog(`â±ï¸ é¢„è®¡è€—æ—¶: ${Math.ceil(maxDrugs * 15 / 60)} åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…...`);
    
    fetch('/api/crawl/batch-search', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            keyword: keyword,
            max_drugs: maxDrugs,
            max_providers_per_drug: maxProviders
        })
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“¦ å¼€å§‹æ‰¹é‡é‡‡é›†';
        
        if (data.code === 0 && data.data.success) {
            const result = data.data;
            
            addLog(`\nâœ… [æ‰¹é‡é‡‡é›†] å®Œæˆï¼`);
            addLog(`ğŸ“Š é‡‡é›†äº† ${result.total_drugs} ä¸ªè¯å“`);
            addLog(`ğŸ“Š æ‰¾åˆ° ${result.total_providers} ä¸ªä¾›åº”å•†`);
            addLog(`ğŸ’¾ ä¿å­˜äº† ${result.total_saved} æ¡æ–°ä»·æ ¼è®°å½•`);
            
            // æ·»åŠ æ£€ç´¢é“¾æ¥
            const searchUrl = `/search?q=${encodeURIComponent(keyword)}`;
            addLog(`\nğŸ” <a href="${searchUrl}" target="_blank" style="color: #0d6efd; text-decoration: underline; font-weight: bold;">ç‚¹å‡»è¿™é‡Œæ£€ç´¢æŸ¥çœ‹å·²å…¥åº“çš„è¯å“æ•°æ®</a>`);
            
            // æ˜¾ç¤ºæ¯ä¸ªè¯å“çš„è¯¦æƒ…
            if (result.drugs && result.drugs.length > 0) {
                addLog(`\nğŸ“‹ è¯å“è¯¦æƒ…ï¼š`);
                result.drugs.forEach((drug, i) => {
                    if (drug.success) {
                        addLog(`  ${i+1}. ${drug.name}`);
                        addLog(`     â””â”€ ${drug.providers_count} ä¸ªä¾›åº”å•†ï¼Œä¿å­˜ ${drug.saved_count} æ¡è®°å½•`);
                    } else {
                        addLog(`  ${i+1}. ${drug.name} âŒ ${drug.error || 'é‡‡é›†å¤±è´¥'}`);
                    }
                });
            }
            
            if (result.error) {
                addLog(`âš ï¸ æç¤º: ${result.error}`);
            }
        } else {
            addLog(`âŒ [æ‰¹é‡é‡‡é›†] å¤±è´¥: ${data.message}`);
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“¦ å¼€å§‹æ‰¹é‡é‡‡é›†';
        addLog(`âŒ è¯·æ±‚å¤±è´¥: ${err.message}`);
    });
}



// é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥TokençŠ¶æ€
checkTokenStatus();
</script>
{% endblock %}
