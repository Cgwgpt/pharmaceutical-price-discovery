# 药品库页面统一优化

## 问题分析

之前系统存在两个功能重复的页面：

1. **搜索页面** (`/search`)
   - 卡片式展示
   - 需要输入关键词才显示结果
   - 显示最新价格

2. **药品库页面** (`/drugs`)
   - 表格式展示
   - 默认显示所有药品
   - 显示价格统计信息
   - 支持排序

**问题**：两个页面功能重复，造成用户困惑，不知道该用哪个。

## 优化方案

### 核心思路
将两个页面合并为一个统一的**药品库**页面，作为唯一的药品浏览和搜索入口。

### 实现内容

#### 1. 统一入口
- **保留**：`/drugs` 作为主入口
- **重定向**：`/search` 自动重定向到 `/drugs?view=card`
- **导航栏**：移除独立的"搜索"链接，只保留"药品库"

#### 2. 双视图模式
支持两种视图模式，用户可自由切换：

**表格视图** (`view=table`)：
- 默认视图
- 适合快速浏览大量药品
- 显示完整的统计信息
- 紧凑的表格布局

**卡片视图** (`view=card`)：
- 可选视图
- 适合详细查看单个药品
- 更直观的视觉效果
- 类似原搜索页面的展示方式

#### 3. 完整功能
- ✅ 搜索功能（支持药品名称、厂家、规格）
- ✅ 排序功能（最近更新、名称、价格数量）
- ✅ 分页功能（每页50条）
- ✅ 视图切换（表格/卡片）
- ✅ 统计信息（药品总数、价格记录数等）

## 代码修改

### 1. 路由层 (`app/routes.py`)

```python
@main_bp.route('/drugs')
def drugs_list():
    """已采集药品列表页面（统一的药品浏览和搜索入口）"""
    # ... 添加 view_mode 参数
    view_mode = request.args.get('view', 'table')  # table or card
    # ...

@main_bp.route('/search')
def search():
    """搜索页面 - 重定向到药品库"""
    keyword = request.args.get('q', '').strip()
    page = request.args.get('page', 1, type=int)
    
    # 重定向到药品库页面，使用卡片视图
    return redirect(url_for('main.drugs_list', q=keyword, page=page, view='card'))
```

### 2. 模板层 (`app/templates/drugs_list.html`)

#### 添加视图切换按钮
```html
<div class="btn-group float-md-end w-100" role="group">
    <a href="..." class="btn btn-sm ...">📊 表格</a>
    <a href="..." class="btn btn-sm ...">🎴 卡片</a>
</div>
```

#### 条件渲染两种视图
```html
{% if view_mode == 'card' %}
    <!-- 卡片视图 -->
    <div class="row">
        {% for drug in drugs %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card card-hover h-100">
                <!-- 卡片内容 -->
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <!-- 表格视图 -->
    <table class="table table-hover">
        <!-- 表格内容 -->
    </table>
{% endif %}
```

### 3. 导航栏 (`app/templates/base.html`)

```html
<!-- 移除独立的"搜索"链接 -->
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('main.drugs_list') }}">药品库</a>
</li>
```

## 使用方式

### 访问药品库
```
http://127.0.0.1:5001/drugs
```

### 搜索药品（表格视图）
```
http://127.0.0.1:5001/drugs?q=天麻
```

### 搜索药品（卡片视图）
```
http://127.0.0.1:5001/drugs?q=天麻&view=card
```

### 切换视图
- 点击页面右上角的"📊 表格"或"🎴 卡片"按钮
- 视图状态会在搜索和排序时保持

### 旧链接兼容
```
http://127.0.0.1:5001/search?q=test
↓ 自动重定向到
http://127.0.0.1:5001/drugs?q=test&view=card
```

## 优势对比

### 优化前
| 功能 | 搜索页面 | 药品库页面 |
|------|---------|-----------|
| 浏览所有药品 | ❌ | ✅ |
| 搜索药品 | ✅ | ❌ |
| 卡片展示 | ✅ | ❌ |
| 表格展示 | ❌ | ✅ |
| 排序功能 | ❌ | ✅ |
| 价格统计 | 部分 | ✅ |

**问题**：功能分散，用户需要在两个页面间切换

### 优化后
| 功能 | 统一药品库 |
|------|-----------|
| 浏览所有药品 | ✅ |
| 搜索药品 | ✅ |
| 卡片展示 | ✅ |
| 表格展示 | ✅ |
| 排序功能 | ✅ |
| 价格统计 | ✅ |
| 视图切换 | ✅ |

**优势**：
- ✅ 功能统一，一个入口完成所有操作
- ✅ 用户体验更好，不需要记忆多个页面
- ✅ 灵活切换视图，适应不同使用场景
- ✅ 保持向后兼容，旧链接自动重定向

## 用户场景

### 场景1：快速浏览所有药品
1. 访问药品库（默认表格视图）
2. 使用排序功能按需排序
3. 分页浏览

### 场景2：搜索特定药品
1. 在搜索框输入关键词
2. 点击搜索按钮
3. 查看搜索结果

### 场景3：详细查看药品信息
1. 搜索或浏览找到目标药品
2. 切换到卡片视图（更直观）
3. 点击"查看详情"按钮

### 场景4：从旧链接访问
1. 点击旧的搜索链接
2. 自动重定向到新的药品库页面
3. 无缝使用新功能

## 技术实现

### 视图模式参数
- 通过 URL 参数 `view` 控制
- 默认值：`table`
- 可选值：`table` | `card`

### 状态保持
- 搜索关键词在视图切换时保持
- 排序方式在视图切换时保持
- 分页状态在视图切换时保持

### 重定向策略
- 旧搜索页面 → 药品库（卡片视图）
- 保留搜索关键词和页码
- HTTP 302 临时重定向

## 测试验证

### 功能测试
- ✅ 表格视图访问
- ✅ 卡片视图访问
- ✅ 搜索功能（两种视图）
- ✅ 排序功能（两种视图）
- ✅ 分页功能（两种视图）
- ✅ 视图切换
- ✅ 旧链接重定向

### 兼容性测试
- ✅ 导航栏链接正常
- ✅ 页面内链接正常
- ✅ 外部链接重定向正常

## 文件清单

### 修改的文件
- `app/routes.py` - 添加视图模式参数，实现重定向
- `app/templates/drugs_list.html` - 添加视图切换和卡片视图
- `app/templates/base.html` - 移除独立搜索链接

### 保留的文件
- `app/templates/search.html` - 保留但不再使用（向后兼容）
- `app/services/price_service.py` - 无需修改

### 新增的文件
- `test_unified_drugs_page.py` - 功能测试脚本
- `UNIFIED_DRUGS_PAGE.md` - 本文档

## 总结

通过将搜索和药品库页面合并，我们：

1. **简化了用户体验**：一个入口完成所有操作
2. **增强了功能**：支持双视图模式，灵活切换
3. **保持了兼容性**：旧链接自动重定向
4. **提升了效率**：减少页面跳转，操作更流畅

这次优化解决了功能重复的问题，让系统更加简洁易用。
