# å…³é”®è¯è¯†åˆ«æ–¹æ¡ˆå®¡æŸ¥æŠ¥å‘Š

## å½“å‰å®ç°

### ä»£ç ä½ç½®
`app/services/crawl_service.py` - `_detect_product_category()`

### è¯†åˆ«é€»è¾‘
```python
def _detect_product_category(self, product_name: str) -> str:
    # 1. åŒ–å¦†å“å…³é”®è¯
    cosmetic_keywords = ['çç éœœ', 'çç è†', 'é¢éœœ', 'ä¹³æ¶²', 'ç²¾å', 
                        'åŒ–å¦†', 'æŠ¤è‚¤', 'æ´—é¢', 'é¢è†œ', 'çœ¼éœœ', 
                        'æ°´', 'éœœ', 'è†', 'çš‡åç‰Œ']
    
    # 2. åŒ»ç–—å™¨æ¢°å…³é”®è¯
    device_keywords = ['è¡€ç³–ä»ª', 'è¡€å‹è®¡', 'ä½“æ¸©è®¡', 'é›¾åŒ–å™¨', 
                      'è½®æ¤…', 'æ‹æ–', 'å£ç½©', 'æ‰‹å¥—', 'çº±å¸ƒ', 
                      'ç»·å¸¦', 'æ³¨å°„å™¨', 'é’ˆå¤´']
    
    # 3. ä¿å¥å“å…³é”®è¯
    health_keywords = ['ç»´ç”Ÿç´ ', 'é’™ç‰‡', 'é±¼æ²¹', 'è›‹ç™½ç²‰', 'ç›Šç”ŸèŒ', 
                      'èƒ¶å›Š', 'ä¿å¥', 'è¥å…»', 'è¡¥é’™', 'è¡¥é“']
    
    # 4. å¤„æ–¹è¯æ ‡è¯†
    if '(rx)' or 'ï¼ˆrxï¼‰' in name:
        return 'drug'
    
    # 5. é»˜è®¤ä¸ºè¯å“
    return 'drug'
```

## æ•°æ®åº“ç»Ÿè®¡

### å½“å‰åˆ†ç±»ç»“æœ
```
è¯å“ (drug):           188ä¸ª (95.4%)
ä¿å¥å“ (health_product): 5ä¸ª (2.5%)
åŒ–å¦†å“ (cosmetic):       3ä¸ª (1.5%)
åŒ»ç–—å™¨æ¢° (medical_device): 1ä¸ª (0.5%)
```

### éè¯å“å•†å“åˆ—è¡¨
```
âœ… åŒ–å¦†å“ (3ä¸ª):
  - çš‡å ç‰‡ä»”ç™€ çç éœœ 25g
  - çš‡åç‰Œ ç‰‡ä»”ç™€ çç è† 20g
  - çš‡åç‰Œ ç‰‡ä»”ç™€ çç è†20g

âŒ ä¿å¥å“ (5ä¸ª) - æœ‰è¯¯åˆ¤:
  - äº¿æ™º å°çŒªä½©å¥‡ ç›Šç”ŸèŒè½¯ç³– 95g(è‰è“å‘³)ç­æ´»å‹ âœ… æ­£ç¡®
  - ç«‹æ™®å¦¥ é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡ 20mg*7ç‰‡(è–„è†œè¡£) âŒ è¯¯åˆ¤ï¼ˆåº”ä¸ºè¯å“ï¼‰
  - ç»´ç¦ä½³ ç»´ç”Ÿç´ Cç‰‡ 0.1g*100ç‰‡ âš ï¸ å¯èƒ½è¯¯åˆ¤ï¼ˆå¯èƒ½æ˜¯è¯å“ï¼‰
  - è¾¾å›  ä¼Šå¯æ–° ç»´ç”Ÿç´ ADæ»´å‰‚ 30ç²’(0-1å²) âš ï¸ å¯èƒ½è¯¯åˆ¤ï¼ˆå¯èƒ½æ˜¯è¯å“ï¼‰
  - é˜¿ä¹ é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡ 10mg*7ç‰‡ âŒ è¯¯åˆ¤ï¼ˆåº”ä¸ºè¯å“ï¼‰

âœ… åŒ»ç–—å™¨æ¢° (1ä¸ª):
  - æœä¼Šåº· åŒ»ç”¨å¤–ç§‘å£ç½© 50ç‰‡(ç‹¬ç«‹åŒ…è£… æ— èŒ)
```

## é—®é¢˜åˆ†æ

### ğŸ”´ ä¸¥é‡é—®é¢˜

#### 1. å…³é”®è¯å†²çª
**é—®é¢˜**: "èƒ¶å›Š"è¢«åˆ—ä¸ºä¿å¥å“å…³é”®è¯ï¼Œä½†å¾ˆå¤šè¯å“ä¹Ÿæ˜¯èƒ¶å›Šå‰‚å‹

**å½±å“**: 
- é˜¿æ‰˜ä¼ä»–æ±€é’™**ç‰‡**è¢«è¯¯åˆ¤ä¸ºä¿å¥å“ï¼ˆå› ä¸ºåŒ…å«"é’™"å­—ï¼‰
- å¦‚æœæœ‰"XXèƒ¶å›Š"çš„è¯å“ï¼Œä¼šè¢«è¯¯åˆ¤

**ç¤ºä¾‹**:
```
ç«‹æ™®å¦¥ é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡  â†’ åŒ…å«"é’™" â†’ ä¿å¥å“ âŒ
å®é™…: å¤„æ–¹è¯ï¼Œç”¨äºé™è¡€è„‚
```

#### 2. å…³é”®è¯è¿‡äºå®½æ³›
**é—®é¢˜**: "æ°´"ã€"éœœ"ã€"è†"ç­‰å­—å¤ªå¸¸è§

**é£é™©**:
- "XXæ°´"å¯èƒ½æ˜¯è¯å“ï¼ˆå¦‚æ³¨å°„ç”¨æ°´ï¼‰
- "XXè†"å¯èƒ½æ˜¯è¯å“ï¼ˆå¦‚è½¯è†å‰‚ï¼‰
- "XXéœœ"å¯èƒ½æ˜¯è¯å“ï¼ˆå¦‚å¤–ç”¨éœœå‰‚ï¼‰

**å½“å‰**: è¿™äº›å…³é”®è¯ä¼šå¯¼è‡´è¯å“è¢«è¯¯åˆ¤ä¸ºåŒ–å¦†å“

#### 3. ä¼˜å…ˆçº§é—®é¢˜
**é—®é¢˜**: æ£€æŸ¥é¡ºåºä¸åˆç†

**å½“å‰é¡ºåº**:
```
1. åŒ–å¦†å“å…³é”®è¯
2. åŒ»ç–—å™¨æ¢°å…³é”®è¯
3. ä¿å¥å“å…³é”®è¯
4. å¤„æ–¹è¯æ ‡è¯† (RX)
5. é»˜è®¤è¯å“
```

**é—®é¢˜**: 
- å¦‚æœè¯å“åç§°åŒ…å«"é’™"ï¼Œåœ¨æ£€æŸ¥åˆ°(RX)ä¹‹å‰å°±è¢«åˆ¤å®šä¸ºä¿å¥å“
- å¤„æ–¹è¯æ ‡è¯†åº”è¯¥ä¼˜å…ˆçº§æœ€é«˜

#### 4. ç»´ç”Ÿç´ ç±»è¯å“è¯¯åˆ¤
**é—®é¢˜**: "ç»´ç”Ÿç´ "è¢«åˆ—ä¸ºä¿å¥å“å…³é”®è¯

**å®é™…æƒ…å†µ**:
- ç»´ç”Ÿç´ Cç‰‡ï¼ˆOTCè¯å“ï¼‰
- ç»´ç”Ÿç´ ADæ»´å‰‚ï¼ˆOTCè¯å“ï¼‰
- è¿™äº›éƒ½æ˜¯è¯å“ï¼Œä¸æ˜¯ä¿å¥å“

**åŒºåˆ†æ ‡å‡†**:
- è¯å“: æœ‰å›½è¯å‡†å­—æ‰¹å‡†æ–‡å·
- ä¿å¥å“: æœ‰å›½é£Ÿå¥å­—æ‰¹å‡†æ–‡å·

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜

#### 5. ç¼ºå°‘OTCæ ‡è¯†è¯†åˆ«
**é—®é¢˜**: åªè¯†åˆ«(RX)å¤„æ–¹è¯ï¼Œä¸è¯†åˆ«OTCéå¤„æ–¹è¯

**å»ºè®®**: æ·»åŠ OTCæ ‡è¯†è¯†åˆ«
```python
if '(otc)' in name_lower or 'otc' in name_lower:
    return 'drug'
```

#### 6. ç¼ºå°‘å‰‚å‹è¯†åˆ«
**é—®é¢˜**: æ²¡æœ‰åˆ©ç”¨å‰‚å‹ä¿¡æ¯

**è¯å“å¸¸è§å‰‚å‹**:
- ç‰‡å‰‚ã€èƒ¶å›Šã€é¢—ç²’ã€å£æœæ¶²ã€æ³¨å°„æ¶²
- è½¯è†ã€ä¹³è†ã€è´´å‰‚ã€æ»´çœ¼æ¶²

**å»ºè®®**: æ·»åŠ å‰‚å‹å…³é”®è¯
```python
drug_forms = ['ç‰‡', 'èƒ¶å›Š', 'é¢—ç²’', 'å£æœæ¶²', 'æ³¨å°„æ¶²', 
              'è½¯è†', 'ä¹³è†', 'è´´å‰‚', 'æ»´çœ¼æ¶²', 'æ»´å‰‚']
```

#### 7. ç¼ºå°‘å‚å®¶ä¿¡æ¯åˆ©ç”¨
**é—®é¢˜**: æ²¡æœ‰åˆ©ç”¨å‚å®¶åç§°åˆ¤æ–­

**ç¤ºä¾‹**:
```
ç¦å»ºç‰‡ä»”ç™€åŒ–å¦†å“æœ‰é™å…¬å¸ â†’ åŒ–å¦†å“
æ¼³å·ç‰‡ä»”ç™€è¯ä¸šè‚¡ä»½æœ‰é™å…¬å¸ â†’ è¯å“
```

### ğŸŸ¢ è½»å¾®é—®é¢˜

#### 8. ç¼ºå°‘ç½®ä¿¡åº¦è¯„åˆ†
**é—®é¢˜**: åªè¿”å›ç±»åˆ«ï¼Œä¸è¿”å›ç½®ä¿¡åº¦

**å»ºè®®**: è¿”å›ç½®ä¿¡åº¦åˆ†æ•°
```python
return {
    'category': 'drug',
    'confidence': 0.95,
    'reason': 'åŒ…å«(RX)æ ‡è¯†'
}
```

#### 9. ç¼ºå°‘æ—¥å¿—è®°å½•
**é—®é¢˜**: æ— æ³•è¿½è¸ªè¯†åˆ«è¿‡ç¨‹

**å»ºè®®**: è®°å½•è¯†åˆ«ä¾æ®
```python
logger.debug(f"è¯†åˆ« {product_name}: åŒ¹é…å…³é”®è¯ '{keyword}' â†’ {category}")
```

## æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤ä¼˜å…ˆçº§å’Œå…³é”®è¯ï¼ˆç«‹å³å®æ–½ï¼‰

```python
def _detect_product_category(self, product_name: str, manufacturer: str = '') -> dict:
    """
    æ”¹è¿›çš„å•†å“ç±»åˆ«æ£€æµ‹
    
    Returns:
        {
            'category': str,
            'confidence': float,  # 0.0-1.0
            'reason': str
        }
    """
    name_lower = product_name.lower()
    mfr_lower = manufacturer.lower()
    
    # ä¼˜å…ˆçº§1: å¤„æ–¹è¯/OTCæ ‡è¯†ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œç½®ä¿¡åº¦100%ï¼‰
    if '(rx)' in name_lower or 'ï¼ˆrxï¼‰' in name_lower:
        return {'category': 'drug', 'confidence': 1.0, 'reason': 'å¤„æ–¹è¯æ ‡è¯†(RX)'}
    
    if '(otc)' in name_lower or 'otc' in name_lower:
        return {'category': 'drug', 'confidence': 1.0, 'reason': 'OTCæ ‡è¯†'}
    
    # ä¼˜å…ˆçº§2: å‚å®¶ä¿¡æ¯ï¼ˆé«˜ç½®ä¿¡åº¦ï¼‰
    if 'åŒ–å¦†å“' in mfr_lower:
        return {'category': 'cosmetic', 'confidence': 0.95, 'reason': 'åŒ–å¦†å“å‚å®¶'}
    
    if 'åŒ»ç–—å™¨æ¢°' in mfr_lower:
        return {'category': 'medical_device', 'confidence': 0.95, 'reason': 'åŒ»ç–—å™¨æ¢°å‚å®¶'}
    
    # ä¼˜å…ˆçº§3: é«˜ç½®ä¿¡åº¦å…³é”®è¯ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
    # åŒ–å¦†å“ - ä½¿ç”¨æ›´ç²¾ç¡®çš„å…³é”®è¯
    cosmetic_high = ['çç éœœ', 'çç è†', 'é¢éœœ', 'ä¹³æ¶²', 'ç²¾åæ¶²', 
                     'æ´—é¢å¥¶', 'é¢è†œ', 'çœ¼éœœ', 'æŠ¤è‚¤æ°´', 'åŒ–å¦†æ°´']
    for keyword in cosmetic_high:
        if keyword in name_lower:
            return {'category': 'cosmetic', 'confidence': 0.9, 'reason': f'åŒ–å¦†å“å…³é”®è¯: {keyword}'}
    
    # åŒ»ç–—å™¨æ¢° - æ˜ç¡®çš„å™¨æ¢°åç§°
    device_high = ['è¡€ç³–ä»ª', 'è¡€å‹è®¡', 'ä½“æ¸©è®¡', 'é›¾åŒ–å™¨', 'åŒ»ç”¨å£ç½©', 
                   'å¤–ç§‘å£ç½©', 'æ³¨å°„å™¨', 'è¾“æ¶²å™¨', 'å¯¼å°¿ç®¡']
    for keyword in device_high:
        if keyword in name_lower:
            return {'category': 'medical_device', 'confidence': 0.9, 'reason': f'åŒ»ç–—å™¨æ¢°: {keyword}'}
    
    # ä¼˜å…ˆçº§4: è¯å“å‰‚å‹ï¼ˆä¸­é«˜ç½®ä¿¡åº¦ï¼‰
    drug_forms = ['ç‰‡', 'èƒ¶å›Š', 'é¢—ç²’', 'å£æœæ¶²', 'æ³¨å°„æ¶²', 'æ³¨å°„å‰‚',
                  'è½¯è†', 'ä¹³è†', 'è´´å‰‚', 'æ»´çœ¼æ¶²', 'æ»´å‰‚', 'ç³–æµ†',
                  'ä¸¸', 'æ•£', 'è†è¯', 'æ “å‰‚', 'å–·é›¾å‰‚']
    for form in drug_forms:
        if form in name_lower:
            return {'category': 'drug', 'confidence': 0.85, 'reason': f'è¯å“å‰‚å‹: {form}'}
    
    # ä¼˜å…ˆçº§5: ä¿å¥å“å…³é”®è¯ï¼ˆéœ€è¦æ’é™¤è¯å“ï¼‰
    # åªæœ‰åœ¨ä¸åŒ…å«è¯å“å‰‚å‹çš„æƒ…å†µä¸‹æ‰åˆ¤å®šä¸ºä¿å¥å“
    health_keywords = ['ç›Šç”ŸèŒè½¯ç³–', 'è›‹ç™½ç²‰', 'é±¼æ²¹', 'ä¿å¥é£Ÿå“']
    for keyword in health_keywords:
        if keyword in name_lower:
            return {'category': 'health_product', 'confidence': 0.8, 'reason': f'ä¿å¥å“: {keyword}'}
    
    # ä¼˜å…ˆçº§6: ä½ç½®ä¿¡åº¦å…³é”®è¯
    # ç»´ç”Ÿç´  - éœ€è¦æ›´å¤šä¸Šä¸‹æ–‡åˆ¤æ–­
    if 'ç»´ç”Ÿç´ ' in name_lower:
        # å¦‚æœæœ‰å‰‚å‹è¯ï¼Œåˆ¤å®šä¸ºè¯å“
        if any(form in name_lower for form in ['ç‰‡', 'èƒ¶å›Š', 'æ»´å‰‚', 'å£æœæ¶²']):
            return {'category': 'drug', 'confidence': 0.7, 'reason': 'ç»´ç”Ÿç´ ç±»è¯å“'}
        else:
            return {'category': 'health_product', 'confidence': 0.6, 'reason': 'ç»´ç”Ÿç´ ç±»ä¿å¥å“'}
    
    # åŒ»ç–—å™¨æ¢° - ä½ç½®ä¿¡åº¦
    device_low = ['å£ç½©', 'æ‰‹å¥—', 'çº±å¸ƒ', 'ç»·å¸¦']
    for keyword in device_low:
        if keyword in name_lower:
            return {'category': 'medical_device', 'confidence': 0.7, 'reason': f'åŒ»ç–—ç”¨å“: {keyword}'}
    
    # é»˜è®¤: è¯å“ï¼ˆä½ç½®ä¿¡åº¦ï¼‰
    return {'category': 'drug', 'confidence': 0.5, 'reason': 'é»˜è®¤åˆ†ç±»'}
```

### æ–¹æ¡ˆ2ï¼šæ·»åŠ è§„åˆ™å¼•æ“ï¼ˆä¸­æœŸï¼‰

```python
class CategoryRule:
    """åˆ†ç±»è§„åˆ™"""
    def __init__(self, pattern, category, confidence, priority):
        self.pattern = pattern  # æ­£åˆ™æˆ–å…³é”®è¯
        self.category = category
        self.confidence = confidence
        self.priority = priority  # ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆ

# è§„åˆ™åº“
RULES = [
    CategoryRule(r'\(RX\)', 'drug', 1.0, 100),
    CategoryRule(r'\(OTC\)', 'drug', 1.0, 100),
    CategoryRule('çç éœœ', 'cosmetic', 0.95, 80),
    CategoryRule('åŒ»ç”¨å£ç½©', 'medical_device', 0.95, 80),
    # ... æ›´å¤šè§„åˆ™
]
```

### æ–¹æ¡ˆ3ï¼šæœºå™¨å­¦ä¹ åˆ†ç±»ï¼ˆé•¿æœŸï¼‰

```python
# ä½¿ç”¨å·²æ ‡æ³¨æ•°æ®è®­ç»ƒåˆ†ç±»æ¨¡å‹
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.naive_bayes import MultinomialNB

# ç‰¹å¾: å•†å“åç§°ã€å‚å®¶ã€è§„æ ¼
# æ ‡ç­¾: drug, cosmetic, medical_device, health_product
```

## ç«‹å³è¡ŒåŠ¨é¡¹

### 1. ä¿®å¤è¯¯åˆ¤çš„å•†å“ï¼ˆç´§æ€¥ï¼‰
```sql
-- ä¿®å¤é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡
UPDATE drugs 
SET category = 'drug' 
WHERE name LIKE '%é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡%';

-- ä¿®å¤ç»´ç”Ÿç´ ç±»è¯å“
UPDATE drugs 
SET category = 'drug' 
WHERE name LIKE '%ç»´ç”Ÿç´ %ç‰‡%' 
   OR name LIKE '%ç»´ç”Ÿç´ %æ»´å‰‚%';
```

### 2. å®æ–½æ”¹è¿›çš„è¯†åˆ«å‡½æ•°ï¼ˆä»Šå¤©ï¼‰
- ä¿®æ”¹ `_detect_product_category()` å‡½æ•°
- æ·»åŠ ä¼˜å…ˆçº§å’Œç½®ä¿¡åº¦
- ç§»é™¤æœ‰é—®é¢˜çš„å…³é”®è¯

### 3. æ·»åŠ æµ‹è¯•ç”¨ä¾‹ï¼ˆä»Šå¤©ï¼‰
```python
test_cases = [
    ('ç«‹æ™®å¦¥ é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡ 20mg*7ç‰‡(è–„è†œè¡£)', 'drug'),
    ('ç»´ç¦ä½³ ç»´ç”Ÿç´ Cç‰‡ 0.1g*100ç‰‡', 'drug'),
    ('çš‡å ç‰‡ä»”ç™€ çç éœœ 25g', 'cosmetic'),
    ('æœä¼Šåº· åŒ»ç”¨å¤–ç§‘å£ç½© 50ç‰‡', 'medical_device'),
    ('äº¿æ™º å°çŒªä½©å¥‡ ç›Šç”ŸèŒè½¯ç³– 95g', 'health_product'),
]
```

### 4. æ·»åŠ äººå·¥å®¡æ ¸æœºåˆ¶ï¼ˆæœ¬å‘¨ï¼‰
```python
# å¯¹ä½ç½®ä¿¡åº¦å•†å“è¿›è¡Œäººå·¥å®¡æ ¸
SELECT * FROM drugs 
WHERE category_confidence < 0.8 
ORDER BY price_count DESC 
LIMIT 50;
```

## æ€»ç»“

### å½“å‰é—®é¢˜
âŒ å…³é”®è¯å†²çªï¼ˆ"é’™"ã€"èƒ¶å›Š"ç­‰ï¼‰  
âŒ ä¼˜å…ˆçº§é”™è¯¯ï¼ˆå¤„æ–¹è¯æ ‡è¯†åº”æœ€ä¼˜å…ˆï¼‰  
âŒ ç»´ç”Ÿç´ ç±»è¯å“è¯¯åˆ¤  
âŒ ç¼ºå°‘ç½®ä¿¡åº¦è¯„åˆ†  
âŒ ç¼ºå°‘OTCè¯†åˆ«  

### æ”¹è¿›åæ•ˆæœé¢„æœŸ
âœ… å‡†ç¡®ç‡ä»90%æå‡åˆ°95%+  
âœ… å¤„æ–¹è¯100%æ­£ç¡®è¯†åˆ«  
âœ… æä¾›ç½®ä¿¡åº¦è¯„åˆ†  
âœ… å¯è¿½æº¯è¯†åˆ«è¿‡ç¨‹  
âœ… æ”¯æŒäººå·¥å®¡æ ¸  

### ä¸‹ä¸€æ­¥
1. ç«‹å³ä¿®å¤æ•°æ®åº“ä¸­çš„è¯¯åˆ¤
2. å®æ–½æ”¹è¿›çš„è¯†åˆ«å‡½æ•°
3. æ·»åŠ æµ‹è¯•ç”¨ä¾‹éªŒè¯
4. å»ºç«‹äººå·¥å®¡æ ¸æµç¨‹
5. æŒç»­ä¼˜åŒ–å…³é”®è¯åº“
